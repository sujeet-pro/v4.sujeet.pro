---
/**
 * Theme Script â€” FOUC Prevention
 *
 * Inline script that runs synchronously before first paint to:
 * 1. Read saved theme from localStorage
 * 2. Resolve "auto" to light/dark based on prefers-color-scheme
 * 3. Apply the theme class to <html>
 * 4. Set color-scheme CSS property
 * 5. Define window.applySiteTheme() for runtime switching
 *
 * Must be rendered in <head> as `is:inline` (not a module).
 */
---

<script is:inline>
  ;(function () {
    var THEMES = ["auto", "light", "dark", "high-contrast-light", "high-contrast-dark", "paper"]
    var STORAGE_KEY = "site-theme"
    var darkQuery = window.matchMedia("(prefers-color-scheme: dark)")

    function getResolvedTheme(theme) {
      if (theme === "auto") {
        return darkQuery.matches ? "dark" : "light"
      }
      return theme
    }

    function getColorScheme(resolved) {
      if (resolved === "dark" || resolved === "high-contrast-dark") return "dark"
      return "light"
    }

    function applyTheme(theme) {
      if (!theme || THEMES.indexOf(theme) === -1) theme = "auto"

      var resolved = getResolvedTheme(theme)
      var root = document.documentElement
      var scheme = getColorScheme(resolved)

      // Remove all theme classes
      for (var i = 0; i < THEMES.length; i++) {
        root.classList.remove("theme-" + THEMES[i])
      }

      // Apply resolved theme class
      root.classList.add("theme-" + resolved)

      // Set color-scheme
      root.style.setProperty("--color-scheme", scheme)

      // Update meta tag
      var meta = document.querySelector('meta[name="color-scheme"]')
      if (meta) meta.setAttribute("content", scheme)

      // Store the user's chosen theme (not the resolved one)
      try {
        localStorage.setItem(STORAGE_KEY, theme)
      } catch (e) {
        // localStorage may be unavailable
      }

      // Dispatch event for other scripts to react
      root.dataset.theme = theme
      root.dataset.resolvedTheme = resolved
    }

    // Apply on load
    var saved = "auto"
    try {
      saved = localStorage.getItem(STORAGE_KEY) || "auto"
    } catch (e) {
      // localStorage may be unavailable
    }
    applyTheme(saved)

    // Listen for OS preference changes when in auto mode
    darkQuery.addEventListener("change", function () {
      var current = "auto"
      try {
        current = localStorage.getItem(STORAGE_KEY) || "auto"
      } catch (e) {}
      if (current === "auto") {
        applyTheme("auto")
      }
    })

    // Expose for runtime use
    window.applySiteTheme = applyTheme
  })()
</script>
