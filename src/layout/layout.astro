---
import "@/styles/global.css"
import Header from "./header.astro"
import Footer from "./footer.astro"
import KatexCSS from "./katex-css.astro"
import Favicons from "./favicons.astro"
import Seo from "./seo.astro"
import type { Props as SeoProps } from "./seo.astro"
import { getFilePath } from "@/utils/link.utils"
import Breadcrumb from "@/components/breadcrumb.astro"
import type { Props as BreadcrumbProps } from "@/components/breadcrumb.astro"
import ImageModal from "@/components/image-modal.astro"
import GoogleAnalytics from "./google-analytics.astro"

interface Props extends SeoProps {
  noIndex?: boolean | undefined | null
  crumbs: BreadcrumbProps["crumbs"] | null
  /** Use "3col" for pages with sidebars (articles with TOC, search with filters) */
  layout?: "default" | "3col"
}

const { noIndex, crumbs, layout = "default", ...seoProps } = Astro.props

// Check if sidebar slots are provided
const hasSidebarLeft = Astro.slots.has("sidebar-left")
const hasSidebarRight = Astro.slots.has("sidebar-right")

// Font paths with base path support
const openSansFontPath = getFilePath("fonts/open-sans-latin-wght-normal.woff2")
const jetBrainsMonoFontPath = getFilePath("fonts/jetbrains-mono-latin-400-normal.woff2")
const searchIndexPath = getFilePath("search/index.json")
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light" />
    {noIndex ? <meta name="robots" content="noindex" /> : null}
    <!-- Inline font-face declarations with base path -->
    <style set:html={`
      @font-face {
        font-family: "Open Sans";
        font-style: normal;
        font-weight: 300 800;
        font-display: swap;
        src: url("${openSansFontPath}") format("woff2");
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329,
          U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }
      @font-face {
        font-family: "JetBrains Mono";
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url("${jetBrainsMonoFontPath}") format("woff2");
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329,
          U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }
    `} />
    <!-- Preload local fonts -->
    <link rel="preload" as="font" type="font/woff2" href={openSansFontPath} crossorigin="anonymous" />
    <link rel="preload" as="font" type="font/woff2" href={jetBrainsMonoFontPath} crossorigin="anonymous" />
    <!-- Prefetch search index in background -->
    <link rel="prefetch" href={searchIndexPath} />
    <Favicons />
    <Seo {...seoProps} />
    <link rel="alternate" type="application/rss+xml" href={getFilePath("rss.xml")} />
    <link rel="sitemap" href={getFilePath("sitemap-index.xml")} />
    <!-- LLM-friendly content -->
    <link rel="alternate" type="text/plain" href={getFilePath("llms.txt")} title="LLM Index" />
    <link rel="alternate" type="text/plain" href={getFilePath("llms-full.txt")} title="LLM Full Content" />
  </head>
  <body>
    <a href="#main" class="skip-link">Skip to main content</a>
    <Header />
    {layout === "3col" ? (
      <!-- 3-column layout: sidebars outside content, content centered -->
      <div class="layout-3col-grid flex-1">
        <!-- Left sidebar column -->
        <aside class="layout-3col-sidebar layout-3col-sidebar-left">
          {hasSidebarLeft && <slot name="sidebar-left" />}
        </aside>

        <!-- Center content column -->
        <div class="layout-3col-content">
          {crumbs ? <Breadcrumb {crumbs} /> : null}
          <slot name="content-top" />
          <main id="main">
            <slot />
          </main>
          <slot name="content-bottom" />
        </div>

        <!-- Right sidebar column -->
        <aside class="layout-3col-sidebar layout-3col-sidebar-right">
          {hasSidebarRight && <slot name="sidebar-right" />}
        </aside>
      </div>
    ) : (
      <!-- Default layout: constrained width -->
      <main id="main" class="flex-1">
        <div class="content-container">
          {crumbs ? <Breadcrumb {crumbs} /> : null}
          <slot />
        </div>
      </main>
    )}
    <Footer />
    <ImageModal />
    <KatexCSS />
    <GoogleAnalytics />
  </body>
</html>
