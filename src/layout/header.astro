---
import Search from "./search.astro"
import Link from "@/components/link.astro"
import { getNavItems } from "@/utils/site.utils"
import { Icon } from "astro-icon/components"

interface Props {
  hasLeftSidebar?: boolean
  hasRightSidebar?: boolean
}

const { hasLeftSidebar = false, hasRightSidebar = false } = Astro.props
const navItems = await getNavItems()
---

<header class="site-header">
  <div class="header-container">
    <nav class="header-nav">
      <!-- Left side: sidebar toggle + logo -->
      <div class="header-left">
        {
          hasLeftSidebar && (
            <button
              id="left-sidebar-toggle"
              class="sidebar-toggle-btn"
              aria-label="Toggle navigation sidebar"
              aria-expanded="true"
            >
              <Icon name="carbon:side-panel-open" class="icon-md" />
            </button>
          )
        }
        <Link href="/" class="header-logo">
          <span class="header-logo-name">sujeet.pro</span>
        </Link>
      </div>

      <!-- Center: Nav links - hidden on mobile -->
      <div class="header-nav-links">
        {
          navItems.map((item) => (
            <Link href={item.path} class="nav-link">
              {item.label}
            </Link>
          ))
        }
      </div>

      <!-- Right side: search + sidebar toggle + hamburger -->
      <div class="header-actions">
        <!-- Search Icon - visible on sm only -->
        <Link href="/search" class="nav-search-icon" aria-label="Search">
          <Icon name="carbon:search" class="icon-md" />
        </Link>

        <!-- Search Input - visible on md and above -->
        <div class="nav-search-input">
          <Search />
        </div>

        {
          hasRightSidebar && (
            <button
              id="right-sidebar-toggle"
              class="sidebar-toggle-btn"
              aria-label="Toggle table of contents"
              aria-expanded="true"
            >
              <Icon name="carbon:side-panel-close" class="icon-md" />
            </button>
          )
        }

        <!-- Hamburger Menu - visible on mobile only -->
        <button
          id="mobile-menu-btn"
          class="mobile-menu-btn"
          aria-label="Open menu"
          aria-expanded="false"
          aria-controls="mobile-menu"
        >
          <Icon name="carbon:menu" class="icon-lg" />
        </button>
      </div>
    </nav>
  </div>
</header>

<!-- Mobile Sidebar -->
<div id="mobile-menu-overlay" class="mobile-menu-overlay is-hidden"></div>
<aside id="mobile-menu" class="mobile-menu" aria-hidden="true">
  <div class="mobile-menu-header">
    <Link href="/" class="nav-link nav-logo"> sujeet.pro </Link>
    <button id="mobile-menu-close" class="mobile-menu-close" aria-label="Close menu">
      <Icon name="carbon:close" class="icon-lg" />
    </button>
  </div>
  <nav class="mobile-menu-nav">
    {
      navItems.map((item) => (
        <Link href={item.path} class="mobile-menu-link">
          {item.label}
        </Link>
      ))
    }
    <Link href="/search" class="mobile-menu-link mobile-menu-link--search">
      <Icon name="carbon:search" class="icon-md" />
      <span>Search</span>
    </Link>
  </nav>
</aside>

<script>
  function initMobileMenu() {
    const menuBtn = document.getElementById("mobile-menu-btn")
    const closeBtn = document.getElementById("mobile-menu-close")
    const overlay = document.getElementById("mobile-menu-overlay")
    const menu = document.getElementById("mobile-menu")

    function openMenu() {
      menu?.classList.add("is-open")
      overlay?.classList.remove("is-hidden")
      menuBtn?.setAttribute("aria-expanded", "true")
      menu?.setAttribute("aria-hidden", "false")
      document.body.style.overflow = "hidden"
    }

    function closeMenu() {
      menu?.classList.remove("is-open")
      overlay?.classList.add("is-hidden")
      menuBtn?.setAttribute("aria-expanded", "false")
      menu?.setAttribute("aria-hidden", "true")
      document.body.style.overflow = ""
    }

    menuBtn?.addEventListener("click", openMenu)
    closeBtn?.addEventListener("click", closeMenu)
    overlay?.addEventListener("click", closeMenu)

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && menu?.classList.contains("is-open")) {
        closeMenu()
      }
    })

    menu?.querySelectorAll("a").forEach((link) => {
      link.addEventListener("click", closeMenu)
    })
  }

  document.addEventListener("DOMContentLoaded", initMobileMenu)
  document.addEventListener("astro:page-load", initMobileMenu)
</script>

<style is:global>
  @reference "tailwindcss";

  .header-container {
    @apply mx-auto w-full px-5 md:px-8;
    max-width: var(--header-width);
  }

  .header-nav {
    @apply flex items-center justify-between gap-6;
    height: var(--header-height);
  }

  .header-left {
    @apply flex items-center gap-2;
  }

  .header-logo {
    @apply no-underline;
  }

  .header-logo-name {
    @apply font-mono text-sm lowercase;
    color: var(--color-text);
    letter-spacing: 0.02em;
    transition: color var(--transition-fast);
  }

  .header-logo:hover .header-logo-name {
    color: var(--color-text-muted);
  }

  .header-nav-links {
    @apply hidden items-center gap-8 md:flex;
  }

  .header-actions {
    @apply flex items-center gap-2;
  }

  /* Sidebar toggles - visible on all screen sizes */
  .sidebar-toggle-btn {
    @apply flex;
  }
</style>
