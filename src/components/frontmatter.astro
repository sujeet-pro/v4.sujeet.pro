---
import { Icon } from "astro-icon/components"
import { CONTENT_TYPE_LABELS } from "@constants/site"
import type { ContentItem, CategoryRef } from "@/utils/content.type"
import Link from "./link.astro"

interface Props {
  minutesRead: string
  /** Published date (optional for in-research content) */
  publishedOn?: Date
  lastReviewedOn?: Date | undefined
  isDraft: boolean
  class?: string
  /** Show content type badge (Writing, Deep Dive, etc.) */
  showType?: boolean
  type?: ContentItem["type"] | "in-research"
  /** Show category alongside type */
  showCategory?: boolean
  category?: CategoryRef
}

const { minutesRead, publishedOn, lastReviewedOn, isDraft, class: className, showType, type, showCategory, category } = Astro.props as Props
const hasReviews = lastReviewedOn && publishedOn && publishedOn.toDateString() !== lastReviewedOn.toDateString()

// Format date with ordinal suffix (e.g., "Published on 20th January 2026")
function getOrdinalSuffix(day: number): string {
  if (day > 3 && day < 21) return 'th'
  switch (day % 10) {
    case 1: return 'st'
    case 2: return 'nd'
    case 3: return 'rd'
    default: return 'th'
  }
}

function formatDateWithOrdinal(date: Date): string {
  const day = date.getDate()
  const month = date.toLocaleDateString("en-US", { month: "long" })
  const year = date.getFullYear()
  return `${day}${getOrdinalSuffix(day)} ${month} ${year}`
}

const publishedOnTitle = publishedOn ? `Published on ${formatDateWithOrdinal(publishedOn)}` : ""
const lastReviewedOnTitle = lastReviewedOn ? `Last Reviewed on ${formatDateWithOrdinal(lastReviewedOn)}` : ""
---

<div class:list={["frontmatter", className]}>
  {isDraft && <span class="badge">Draft</span>}

  {/* Type and Category together as breadcrumb-style */}
  {(showType || showCategory) && (
    <span class="frontmatter-item">
      {showType && type && (
        <span class="text-muted">{CONTENT_TYPE_LABELS[type]}</span>
      )}
      {showType && showCategory && category && (
        <span class="text-muted">/</span>
      )}
      {showCategory && category && (
        <Link href={category.href} class="frontmatter-link" title={`Category - ${category.title}`}>{category.name}</Link>
      )}
    </span>
  )}

  <span class="frontmatter-item">
    <Icon name="carbon:time" class="icon-sm" />
    {minutesRead}
  </span>

  {publishedOn && (
    <span class="frontmatter-item" title={publishedOnTitle}>
      <Icon name="carbon:calendar" class="icon-sm" />
      <time datetime={publishedOn.toISOString()}>
        {
          publishedOn.toLocaleDateString("en-us", {
            year: "numeric",
            month: "short",
            day: "numeric",
          })
        }
      </time>
    </span>
  )}

  {
    hasReviews && lastReviewedOn && (
      <span class="frontmatter-item" title={lastReviewedOnTitle}>
        <Icon name="carbon:update-now" class="icon-sm" />
        <time datetime={lastReviewedOn.toISOString()}>
          {lastReviewedOn.toLocaleDateString("en-us", {
            year: "numeric",
            month: "short",
            day: "numeric",
          })}
        </time>
      </span>
    )
  }
</div>
