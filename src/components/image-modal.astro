---
// Image Modal Component
// Allows clicking on images/SVGs in articles to view them in a zoomable modal
---

<!-- Image Modal -->
<div id="image-modal" class="image-modal" role="dialog" aria-modal="true" aria-label="Image viewer">
  <div class="image-modal-backdrop"></div>
  <div class="image-modal-content">
    <div class="image-modal-header">
      <div class="image-modal-controls">
        <button type="button" id="image-zoom-out" class="image-modal-btn" aria-label="Zoom out" title="Zoom out">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-md">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            <line x1="8" y1="11" x2="14" y2="11"/>
          </svg>
        </button>
        <span id="image-zoom-level" class="image-zoom-level">100%</span>
        <button type="button" id="image-zoom-in" class="image-modal-btn" aria-label="Zoom in" title="Zoom in">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-md">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            <line x1="11" y1="8" x2="11" y2="14"/>
            <line x1="8" y1="11" x2="14" y2="11"/>
          </svg>
        </button>
        <button type="button" id="image-zoom-reset" class="image-modal-btn" aria-label="Reset zoom" title="Reset zoom">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-md">
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
            <path d="M3 3v5h5"/>
          </svg>
        </button>
      </div>
      <button type="button" id="image-modal-close" class="image-modal-btn image-modal-close" aria-label="Close image viewer">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-md">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="image-modal-body" id="image-modal-body">
      <!-- Cloned image will be inserted here -->
    </div>
  </div>
</div>

<script>
  function initImageModal() {
    const modal = document.getElementById('image-modal')
    const modalBody = document.getElementById('image-modal-body')
    const backdrop = modal?.querySelector('.image-modal-backdrop')
    const closeBtn = document.getElementById('image-modal-close')
    const zoomInBtn = document.getElementById('image-zoom-in')
    const zoomOutBtn = document.getElementById('image-zoom-out')
    const zoomResetBtn = document.getElementById('image-zoom-reset')
    const zoomLevelDisplay = document.getElementById('image-zoom-level')

    if (!modal || !modalBody) return

    let currentZoom = 1
    let currentImage: HTMLElement | null = null
    const ZOOM_STEP = 0.25
    const MIN_ZOOM = 0.25
    const MAX_ZOOM = 4

    function updateZoomLevel() {
      if (zoomLevelDisplay) {
        zoomLevelDisplay.textContent = `${Math.round(currentZoom * 100)}%`
      }
      if (currentImage) {
        currentImage.style.transform = `scale(${currentZoom})`
      }
    }

    function openModal(sourceElement: HTMLElement) {
      // Clone the element
      const clone = sourceElement.cloneNode(true) as HTMLElement

      // Reset any transforms on the clone
      clone.style.transform = ''
      clone.style.cursor = 'grab'
      clone.classList.add('image-modal-image')

      // Remove any click handlers by cloning
      clone.removeAttribute('onclick')

      // Clear previous content and add new
      modalBody.innerHTML = ''
      modalBody.appendChild(clone)

      currentImage = clone
      currentZoom = 1
      updateZoomLevel()

      // Show modal
      modal.classList.add('open')
      document.body.style.overflow = 'hidden'
      closeBtn?.focus()

      // Enable drag to pan when zoomed
      let isDragging = false
      let startX = 0
      let startY = 0
      let translateX = 0
      let translateY = 0

      clone.addEventListener('mousedown', (e) => {
        if (currentZoom > 1) {
          isDragging = true
          clone.style.cursor = 'grabbing'
          startX = e.clientX - translateX
          startY = e.clientY - translateY
        }
      })

      document.addEventListener('mousemove', (e) => {
        if (isDragging && currentImage) {
          translateX = e.clientX - startX
          translateY = e.clientY - startY
          currentImage.style.transform = `scale(${currentZoom}) translate(${translateX / currentZoom}px, ${translateY / currentZoom}px)`
        }
      })

      document.addEventListener('mouseup', () => {
        isDragging = false
        if (clone) {
          clone.style.cursor = currentZoom > 1 ? 'grab' : 'default'
        }
      })
    }

    function closeModal() {
      modal.classList.remove('open')
      document.body.style.overflow = ''
      modalBody.innerHTML = ''
      currentImage = null
      currentZoom = 1
    }

    function zoomIn() {
      if (currentZoom < MAX_ZOOM) {
        currentZoom = Math.min(MAX_ZOOM, currentZoom + ZOOM_STEP)
        updateZoomLevel()
      }
    }

    function zoomOut() {
      if (currentZoom > MIN_ZOOM) {
        currentZoom = Math.max(MIN_ZOOM, currentZoom - ZOOM_STEP)
        updateZoomLevel()
      }
    }

    function resetZoom() {
      currentZoom = 1
      if (currentImage) {
        currentImage.style.transform = `scale(${currentZoom})`
      }
      updateZoomLevel()
    }

    // Event listeners
    closeBtn?.addEventListener('click', closeModal)
    backdrop?.addEventListener('click', closeModal)
    zoomInBtn?.addEventListener('click', zoomIn)
    zoomOutBtn?.addEventListener('click', zoomOut)
    zoomResetBtn?.addEventListener('click', resetZoom)

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (!modal.classList.contains('open')) return

      switch (e.key) {
        case 'Escape':
          closeModal()
          break
        case '+':
        case '=':
          zoomIn()
          break
        case '-':
          zoomOut()
          break
        case '0':
          resetZoom()
          break
      }
    })

    // Mouse wheel zoom
    modalBody.addEventListener('wheel', (e) => {
      e.preventDefault()
      if (e.deltaY < 0) {
        zoomIn()
      } else {
        zoomOut()
      }
    }, { passive: false })

    // Attach click handlers to images in articles
    function attachImageHandlers() {
      // Select images and SVGs within prose/article content
      const selectors = [
        '.prose img:not([data-no-modal])',
        '.prose svg:not([data-icon]):not([data-no-modal])',
        '.prose .mermaid svg:not([data-no-modal])',
        'article img:not([data-no-modal])',
        'article svg:not([data-icon]):not([data-no-modal])',
        'figure img:not([data-no-modal])',
        'figure svg:not([data-icon]):not([data-no-modal])'
      ]

      const images = document.querySelectorAll<HTMLElement>(selectors.join(', '))

      images.forEach((img) => {
        // Skip if already has handler
        if (img.dataset.modalEnabled) return

        img.dataset.modalEnabled = 'true'
        img.style.cursor = 'zoom-in'

        img.addEventListener('click', (e) => {
          e.preventDefault()
          e.stopPropagation()
          openModal(img)
        })
      })
    }

    // Initialize handlers
    attachImageHandlers()

    // Re-attach on dynamic content changes (for Astro View Transitions)
    const observer = new MutationObserver(() => {
      attachImageHandlers()
    })

    const article = document.querySelector('article') || document.querySelector('.prose')
    if (article) {
      observer.observe(article, { childList: true, subtree: true })
    }
  }

  // Initialize on DOM ready
  document.addEventListener('DOMContentLoaded', initImageModal)

  // Re-initialize on Astro page navigation
  document.addEventListener('astro:page-load', initImageModal)
</script>

<style is:global>
  @reference "tailwindcss";

  .image-modal {
    @apply fixed inset-0 z-60 hidden;
  }

  .image-modal.open {
    @apply flex flex-col;
  }

  .image-modal-backdrop {
    @apply absolute inset-0;
    background-color: rgb(0 0 0 / 0.9);
  }

  .image-modal-content {
    @apply relative flex h-full w-full flex-col;
  }

  .image-modal-header {
    @apply relative z-10 flex items-center justify-between px-4 py-3;
    background: rgb(0 0 0 / 0.5);
  }

  .image-modal-controls {
    @apply flex items-center gap-2;
  }

  .image-modal-btn {
    @apply flex cursor-pointer items-center justify-center rounded-md border-none bg-transparent p-2;
    color: white;
    min-width: var(--min-touch-target);
    min-height: var(--min-touch-target);
    transition: background-color var(--transition-fast);
  }

  .image-modal-btn:hover {
    background: rgb(255 255 255 / 0.1);
  }

  .image-modal-btn:focus {
    @apply outline-2 outline-offset-2;
    outline-color: white;
  }

  .image-zoom-level {
    @apply min-w-14 text-center text-sm;
    color: white;
    font-variant-numeric: tabular-nums;
  }

  .image-modal-body {
    @apply flex flex-1 items-center justify-center overflow-auto p-4;
  }

  .image-modal-body .image-modal-image {
    @apply max-h-full max-w-full select-none object-contain;
    transition: transform var(--transition-fast);
  }

  .image-modal-body svg.image-modal-image {
    @apply h-auto w-auto max-w-[90vw] rounded-lg bg-white p-4;
    max-height: 80vh;
  }
</style>
