---
import type { HTMLAttributes } from "astro/types"
import { getLinkProps } from "@/utils/link.utils"
import { Icon } from "astro-icon/components"
import { getVanityUrlMap } from "@/utils/content-vanity.utils"

const {
  href: propsHref,
  target: propsTarget,
  rel: propsRel,
  icon,
  class: propsClass,
  isVanity,
  ...props
} = Astro.props as HTMLAttributes<"a"> & {
  icon?: string
  isVanity?: boolean
}

if (!propsHref) {
  throw new Error("href is required")
}
if (typeof propsHref !== "string") {
  throw new Error("href must be a string")
}

const vanity = await getVanityUrlMap()
const vanityHrefKey = propsHref.replace(/^\/|\/$/g, "")

if (isVanity && !vanity.has(vanityHrefKey)) {
  throw new Error(`Vanity URL ${propsHref} not found`)
} else if (!isVanity && vanity.has(vanityHrefKey)) {
  throw new Error(`Vanity URL ${propsHref} found but isVanity is false`)
}

const { href, target, rel } = getLinkProps({
  href: isVanity ? (vanity.get(vanityHrefKey) ?? propsHref) : propsHref,
  target: propsTarget,
  rel: propsRel,
})

// Default to 'link' class if no class provided (for inline links in content)
const linkClass = propsClass || "link"
---

<a {...props} {href} {target} {rel} class:list={[linkClass, icon && "inline-flex items-center gap-2"]}>
  {icon && <Icon name={icon} />}
  <slot />
</a>
