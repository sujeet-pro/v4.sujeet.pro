---
import { Icon } from "astro-icon/components"
import ArticleNavigation from "@/components/article-navigation.astro"
import ArticleTags from "@/components/article-tags.astro"
import CategoryNav from "@/components/category-nav.astro"
import TOC from "@/components/toc.astro"
import Frontmatter from "@/components/frontmatter.astro"
import Layout from "@/layout/layout.astro"
import ReadingProgress from "@/components/reading-progress.astro"
import { getDeepDivesIncludingDrafts } from "@/utils/content-collection.utils"

// Generate static paths for all deep-dives (including drafts)
export async function getStaticPaths() {
  const deepDives = await getDeepDivesIncludingDrafts()

  return deepDives.map((dd, index) => {
    const nextDeepDive = index < deepDives.length - 1 ? deepDives[index + 1] : null
    const prevDeepDive = index > 0 ? deepDives[index - 1] : null

    // Get all articles in the current category for category nav
    const categoryArticles = deepDives
      .filter((d) => d.category.id === dd.category.id)
      .map((d) => ({
        id: d.id,
        title: d.title,
        href: d.href,
      }))

    return {
      params: { slug: dd.pageSlug },
      props: {
        deepDive: dd,
        categoryArticles,
        nextDeepDive,
        prevDeepDive,
      },
    }
  })
}

const { deepDive, categoryArticles, nextDeepDive, prevDeepDive } = Astro.props
const { description, publishedOn, lastUpdatedOn, title, minutesRead, tags, Content, isDraft, category } = deepDive

const crumbs = [
  { name: "Deep Dives", href: "/deep-dives" },
  { name: category.name, href: category.href, title: category.title },
]
---

<Layout {title} {description} {crumbs} pageType="article" noIndex={isDraft} layout="3col">
  <!-- Category Nav in left sidebar (desktop only) -->
  <CategoryNav
    slot="sidebar-left"
    categoryName={category.name}
    articles={categoryArticles}
    currentArticleId={deepDive.id}
  />

  <!-- TOC in right sidebar -->
  <TOC slot="sidebar-right" />

  <!-- Content top (above main) -->
  <ReadingProgress slot="content-top" />

  <!-- Category Nav inline (mobile/tablet only - below breadcrumb) -->
  <details slot="content-top" class="category-nav-inline" id="category-nav-inline">
    <summary class="category-nav-inline-summary">
      <span class="category-nav-inline-title">
        <Icon name="carbon:list" class="icon-sm" />
        {category.name}
      </span>
      <Icon name="carbon:chevron-down" class="category-nav-inline-icon" />
    </summary>
    <nav class="category-nav-inline-content" aria-label={`${category.name} articles`}>
      <ul class="category-nav-list">
        {
          categoryArticles.map((article) => {
            const isCurrent = article.id === deepDive.id
            return (
              <li class="category-nav-item">
                <a
                  href={article.href}
                  class:list={[
                    "category-nav-link",
                    { "category-nav-link-active": isCurrent }
                  ]}
                  aria-current={isCurrent ? "page" : undefined}
                >
                  {article.title}
                </a>
              </li>
            )
          })
        }
      </ul>
    </nav>
  </details>

  <Frontmatter slot="content-top" {minutesRead} {publishedOn} {lastUpdatedOn} {isDraft} class="my-4" />

  <!-- Main content (default slot) -->
  <article class="article-prose-content">
    <Content />
  </article>

  <!-- Content bottom (below main) -->
  <ArticleTags slot="content-bottom" {tags} />
  <ArticleNavigation slot="content-bottom" prevItem={prevDeepDive} nextItem={nextDeepDive} />
</Layout>
