---
import ArticleCard from "@/components/article-card.astro"
import Layout from "@/layout/layout.astro"
import { getAllTopicPaths, getTopicPage } from "@/utils/content"
import { formatCount } from "@/utils/format.utils"

export async function getStaticPaths() {
  const paths = await getAllTopicPaths()
  return paths.map(({ category, topic }) => ({
    params: { category, topic },
  }))
}

const { category: categoryId, topic: topicId } = Astro.params
const pageData = await getTopicPage(categoryId, topicId)

if (!pageData) {
  return Astro.redirect("/404")
}

const { topic, index: topicIndex, articles } = pageData
const { category } = topic
const crumbs = [{ name: category.name, href: category.href }]
const { Content } = topicIndex
---

<Layout
  title={topicIndex.title}
  description={topicIndex.description}
  {crumbs}
  pageType="default"
  noIndex={topicIndex.isDraft}
>
  <!-- Render the topic's markdown content -->
  <article class="prose topic-content">
    <Content />
  </article>

  <!-- Articles Section -->
  <section class="articles-section">
    <div class="section-divider">
      <span class="section-divider-text">All Articles ({formatCount(articles.length, "article")})</span>
    </div>
    {
      articles.length > 0 ? (
        <ul class="article-list">
          {articles.map((article, index) => (
            <div class="article-item-animated" style={`animation-delay: ${Math.min(index * 50, 300)}ms`}>
              <ArticleCard article={article} headingLevel="h3" />
            </div>
          ))}
        </ul>
      ) : (
        <p class="text-muted empty-state">No articles yet in this topic.</p>
      )
    }
  </section>
</Layout>

<style is:global>
  @reference "tailwindcss";

  .topic-content {
    @apply mb-12;
    animation: fadeInUp var(--transition-slow) forwards;
  }

  .articles-section {
    @apply mb-8;
  }

  .article-item-animated {
    animation: fadeInUp var(--transition-slow) forwards;
    opacity: 0;
  }

  .empty-state {
    @apply py-12 text-center;
  }
</style>
