---
import { getWriting } from "@/utils/content-writing.utils"
import Layout from "@/layout/layout.astro"
import ArticleWithTOC from "@/components/article-with-toc.astro"
import Item from "@/components/item.astro"
import { getSeriesNavigation } from "@/utils/content-series.utils"
import Frontmatter from "@/components/frontmatter.astro"
import Link from "@/components/link.astro"
import Accordion from "@/components/accordion.astro"

// Generate static paths for all writing
export async function getStaticPaths() {
  const writing = await getWriting()

  return writing.map((item, index) => {
    const nextItem = index < writing.length - 1 ? writing[index + 1] : null
    const prevItem = index > 0 ? writing[index - 1] : null

    return {
      params: { slug: item.pageSlug },
      props: {
        item,
        nextItem,
        prevItem,
      },
    }
  })
}

const { item, nextItem, prevItem } = Astro.props
const { description, publishedOn, lastUpdatedOn, title, minutesRead, tags, Content, isDraft, id } = item

// Get series navigation if this item is part of a series
const { series, prevInSeries, nextInSeries, currentIndex, totalInSeries } = await getSeriesNavigation(id)

// Build navigation items with deduplication
const navigationItems: Array<{ title: string; item: typeof item }> = []
const addedItems = new Map<string, number>()

// Add series navigation first
if (prevInSeries) {
  navigationItems.push({
    title: `Previous in series: ${series!.name}`,
    item: prevInSeries as typeof item,
  })
  addedItems.set(prevInSeries.id, navigationItems.length - 1)
}

if (nextInSeries) {
  navigationItems.push({
    title: `Next in series: ${series!.name}`,
    item: nextInSeries as typeof item,
  })
  addedItems.set(nextInSeries.id, navigationItems.length - 1)
}

// Add chronological navigation with deduplication
if (prevItem) {
  const existingIndex = addedItems.get(prevItem.id)
  const existingItem = existingIndex !== undefined ? navigationItems[existingIndex] : undefined
  if (existingItem) {
    existingItem.title += " · Next"
  } else {
    navigationItems.push({
      title: "Next",
      item: prevItem,
    })
  }
}

if (nextItem) {
  const existingIndex = addedItems.get(nextItem.id)
  const existingItem = existingIndex !== undefined ? navigationItems[existingIndex] : undefined
  if (existingItem) {
    existingItem.title += " · Previous"
  } else {
    navigationItems.push({
      title: "Previous",
      item: nextItem,
    })
  }
}

const crumbs = [
  {
    title: "Writing",
    href: "/writing",
  },
]
if (series) {
  crumbs.push({
    title: series.name,
    href: series.href,
  })
}
---

<Layout {title} {description} {crumbs} pageType="article" noIndex={isDraft}>
  <Frontmatter {minutesRead} {publishedOn} {lastUpdatedOn} {isDraft} class="my-4" />
  {
    series && (
      <Accordion title={`Part of Series: ${series.name} (${currentIndex + 1}/${totalInSeries})`} open={true}>
        <ol class="list-inside list-decimal space-y-2 p-0">
          {series.items.map((seriesItem) => (
            <li class="pl-2">
              {seriesItem.id === id ? (
                <span class="font-medium text-accent">{seriesItem.title}</span>
              ) : (
                <Link href={seriesItem.href} class="hover:underline">
                  {seriesItem.title}
                </Link>
              )}
            </li>
          ))}
        </ol>
      </Accordion>
    )
  }
  <ArticleWithTOC>
    <Content />
  </ArticleWithTOC>

  <!-- Tags -->
  {
    tags.length > 0 && (
      <section class="sp-border-muted mt-12 border-t pt-12">
        <h2 class="mb-6 text-2xl font-light">Tags</h2>
        <div class="flex flex-wrap gap-2">
          {tags.map((tag) => (
            <Link href={tag.href} class="px-3 py-1 text-sm">
              #{tag.name}
            </Link>
          ))}
        </div>
      </section>
    )
  }

  <!-- Read more -->
  {
    navigationItems.length > 0 && (
      <section class="mt-12">
        <h2 class="mb-6 text-2xl font-light">Read more</h2>
        <ul class="flex flex-col">
          {navigationItems.map(({ title: textHeading, item: navItem }) => (
            <Item textHeading={textHeading} item={navItem} />
          ))}
        </ul>
      </section>
    )
  }
</Layout>
