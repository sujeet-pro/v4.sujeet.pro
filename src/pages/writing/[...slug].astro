---
import { getWriting } from "@/utils/content-writing.utils"
import Layout from "@/layout/layout.astro"
import ArticleWithTOC from "@/components/article-with-toc.astro"
import TOC from "@/components/toc.astro"
import Item from "@/components/item.astro"
import Frontmatter from "@/components/frontmatter.astro"
import Link from "@/components/link.astro"

// Generate static paths for all writing
export async function getStaticPaths() {
  const writing = await getWriting()

  return writing.map((item, index) => {
    const nextItem = index < writing.length - 1 ? writing[index + 1] : null
    const prevItem = index > 0 ? writing[index - 1] : null

    return {
      params: { slug: item.pageSlug },
      props: {
        item,
        nextItem,
        prevItem,
      },
    }
  })
}

const { item, nextItem, prevItem } = Astro.props
const { description, publishedOn, lastUpdatedOn, title, minutesRead, tags, Content, isDraft, category } = item

const crumbs = [
  { title: "Writing", href: "/writing" },
  ...(category ? [{ title: category.name, href: category.href }] : []),
]
---

<Layout {title} {description} {crumbs} pageType="article" noIndex={isDraft} layout="3col">
  <!-- TOC in right sidebar -->
  <TOC slot="sidebar-right" />

  <!-- Main content -->
  <Frontmatter {minutesRead} {publishedOn} {lastUpdatedOn} {isDraft} class="my-4" />
  <ArticleWithTOC>
    <Content />
  </ArticleWithTOC>

  <!-- Tags -->
  {
    tags.length > 0 && (
      <section class="sp-border-muted mt-12 border-t pt-12">
        <h2 class="mb-6 text-2xl font-light">Tags</h2>
        <div class="flex flex-wrap gap-2">
          {tags.map((tag) => (
            <Link href={tag.href} class="px-3 py-1 text-sm">
              #{tag.name}
            </Link>
          ))}
        </div>
      </section>
    )
  }

  <!-- Read more -->
  {
    (prevItem || nextItem) && (
      <section class="mt-12">
        <h2 class="mb-6 text-2xl font-light">Read more</h2>
        <ul class="flex flex-col">
          {prevItem && <Item textHeading="Next" item={prevItem} />}
          {nextItem && <Item textHeading="Previous" item={nextItem} />}
        </ul>
      </section>
    )
  }
</Layout>
