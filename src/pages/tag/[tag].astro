---
import Item from "@/components/item.astro"
import Layout from "@/layout/layout.astro"
import { getAllUsedTags } from "@/utils/content-tags.utils"
import { getAllContentItems } from "@/utils/content.utils"

export async function getStaticPaths() {
  const allContent = await getAllContentItems()
  const usedTags = await getAllUsedTags()

  const tagAndContent = usedTags
    .map((tag) => {
      const content = allContent.filter((item) => item.tags.some((itemTag) => itemTag.id === tag.id))
      if (content.length === 0) return null
      return {
        tag,
        content,
      }
    })
    .filter((item): item is NonNullable<typeof item> => item !== null)

  return tagAndContent.map(({ tag, content }) => ({
    params: { tag: tag.id },
    props: {
      tag,
      content,
    },
  }))
}

const { tag, content } = Astro.props
const crumbs = [
  {
    title: "Tags",
    href: "/tag",
  },
]

// Sort content by publishedOn date (newest first)
const sortedContent = [...content].sort((a, b) => b.publishedOn.getTime() - a.publishedOn.getTime())
---

<Layout title={`Tag: ${tag.name}`} description={`Content tagged with ${tag.name}`} {crumbs} pageType="default">
  <h1 class="page-title">#{tag.name}</h1>
  <p class="page-description">{sortedContent.length} items</p>

  <ul class="content-list">
    {sortedContent.map((item) => <Item item={item} showType={true} />)}
  </ul>
</Layout>
