---
import Link from "@/components/link.astro"
import Layout from "@/layout/layout.astro"
import { getAllUsedTags } from "@/utils/content-tags.utils"
import { getAllContentItems } from "@/utils/content.utils"

const allContent = await getAllContentItems()
const tags = await getAllUsedTags()

// Get content count for each tag
const tagsWithCount = tags
  .map((tag) => {
    const contentCount = allContent.filter((item) => item.tags.some((itemTag) => itemTag.id === tag.id)).length
    if (contentCount === 0) return null
    return {
      ...tag,
      contentCount,
    }
  })
  .filter((tag): tag is NonNullable<typeof tag> => tag !== null)

// Sort tags by content count (descending) and then alphabetically
const sortedTags = tagsWithCount.sort((a, b) => {
  if (b.contentCount !== a.contentCount) {
    return b.contentCount - a.contentCount
  }
  return a.name.localeCompare(b.name)
})

const totalTags = tagsWithCount.length
const totalContent = allContent.length
const crumbs = null
---

<Layout title="Tags" description="All tags" {crumbs} pageType="default">
  <h1 class="page-title">Tags</h1>
  <p class="page-description">
    Explore {totalTags} tags across {totalContent} items
  </p>

  <ul class="content-list">
    {
      sortedTags.map((tag) => (
        <li class="content-item">
          <Link href={tag.href} class="tag-list-link">
            <span>#{tag.name}</span>
            <span class="text-muted text-sm">{tag.contentCount}</span>
          </Link>
        </li>
      ))
    }
  </ul>

  {
    sortedTags.length === 0 && (
      <div class="mt-12 text-center">
        <h3 class="heading-3 mb-2">No tags found</h3>
        <p class="text-muted">Tags will appear here once content is added.</p>
      </div>
    )
  }
</Layout>

<style is:global>
  @reference "tailwindcss";

  .tag-list-link {
    @apply flex items-center justify-between;
    color: var(--color-text-secondary);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .tag-list-link:hover {
    color: var(--color-accent);
  }
</style>
