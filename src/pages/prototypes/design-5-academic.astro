---
// Design 5: "Academic Paper"
// Scholarly typography, footnote-style TOC, margin notes, serif elegance
// EB Garamond (body + headings) + Inconsolata (code/mono)
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Design 5: Academic Paper | sujeet.pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Inconsolata:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Skip link -->
    <a href="#main-content" class="acad-skip-link">Skip to content</a>

    <!-- ================================================================
         HEADER - Minimal thin-line academic style
         ================================================================ -->
    <header class="acad-header">
      <div class="acad-header-inner">
        <button
          type="button"
          class="acad-header-btn acad-toggle-left"
          aria-label="Toggle navigation"
          aria-expanded="false"
          aria-controls="sidebar-left"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="12" x2="15" y2="12"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>

        <a href="/" class="acad-logo">sujeet<span class="acad-logo-dot">.</span>pro</a>

        <div class="acad-header-actions">
          <a href="/search" class="acad-header-btn" aria-label="Search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </a>
          <button
            type="button"
            class="acad-header-btn acad-toggle-right"
            aria-label="Toggle table of contents"
            aria-expanded="false"
            aria-controls="sidebar-right"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <line x1="8" y1="6" x2="21" y2="6"></line>
              <line x1="8" y1="12" x2="21" y2="12"></line>
              <line x1="8" y1="18" x2="21" y2="18"></line>
              <circle cx="4" cy="6" r="1.5" fill="currentColor" stroke="none"></circle>
              <circle cx="4" cy="12" r="1.5" fill="currentColor" stroke="none"></circle>
              <circle cx="4" cy="18" r="1.5" fill="currentColor" stroke="none"></circle>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Backdrop overlay for sidebars -->
    <div class="acad-backdrop" id="sidebar-backdrop" aria-hidden="true"></div>

    <!-- ================================================================
         LEFT SIDEBAR - Library/Catalog Browse Navigation
         ================================================================ -->
    <aside class="acad-sidebar acad-sidebar-left" id="sidebar-left" aria-label="Site navigation">
      <div class="acad-sidebar-header">
        <span class="acad-sidebar-title">Library Catalog</span>
        <button type="button" class="acad-sidebar-close" aria-label="Close navigation">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <nav class="acad-sidebar-body">
        <!-- Navigation links -->
        <div class="acad-nav-section">
          <a href="/" class="acad-nav-link">Home</a>
          <a href="/browse" class="acad-nav-link">Browse Collection</a>
          <a href="/articles" class="acad-nav-link">All Papers</a>
          <a href="/search" class="acad-nav-link">Search Index</a>
        </div>
        <div class="acad-nav-divider"></div>
        <!-- Browse: Categories > Topics > Articles -->
        <div class="acad-browse">
          <span class="acad-browse-label">Subject Areas</span>
          <!-- Category 1: System Design -->
          <details class="acad-cat" open>
            <summary class="acad-cat-summary">
              <span class="acad-cat-name">System Design</span>
              <svg class="acad-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </summary>
            <div class="acad-cat-body">
              <details class="acad-topic">
                <summary class="acad-topic-summary">Fundamentals <span class="acad-count">19</span></summary>
                <ul class="acad-article-list">
                  <li><a href="#" class="acad-article-link acad-article-link--active">Distributed Consensus</a></li>
                  <li><a href="#" class="acad-article-link">CAP Theorem</a></li>
                  <li><a href="#" class="acad-article-link">Time and Ordering</a></li>
                  <li><a href="#" class="acad-article-link">Load Balancers</a></li>
                  <li><a href="#" class="acad-article-link">Caching Strategies</a></li>
                </ul>
              </details>
              <details class="acad-topic">
                <summary class="acad-topic-summary">Design Problems <span class="acad-count">24</span></summary>
                <ul class="acad-article-list">
                  <li><a href="#" class="acad-article-link">Design YouTube</a></li>
                  <li><a href="#" class="acad-article-link">Design Uber</a></li>
                  <li><a href="#" class="acad-article-link">Design Chat System</a></li>
                </ul>
              </details>
            </div>
          </details>
          <!-- Category 2: Frontend Engineering -->
          <details class="acad-cat">
            <summary class="acad-cat-summary">
              <span class="acad-cat-name">Frontend Engineering</span>
              <svg class="acad-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </summary>
            <div class="acad-cat-body">
              <details class="acad-topic">
                <summary class="acad-topic-summary">React Patterns <span class="acad-count">8</span></summary>
                <ul class="acad-article-list">
                  <li><a href="#" class="acad-article-link">Component Composition</a></li>
                  <li><a href="#" class="acad-article-link">State Management</a></li>
                  <li><a href="#" class="acad-article-link">Performance Hooks</a></li>
                </ul>
              </details>
              <details class="acad-topic">
                <summary class="acad-topic-summary">Performance <span class="acad-count">6</span></summary>
                <ul class="acad-article-list">
                  <li><a href="#" class="acad-article-link">Web Vitals</a></li>
                  <li><a href="#" class="acad-article-link">Bundle Optimization</a></li>
                </ul>
              </details>
            </div>
          </details>
          <!-- Category 3: Programming Patterns -->
          <details class="acad-cat">
            <summary class="acad-cat-summary">
              <span class="acad-cat-name">Programming Patterns</span>
              <svg class="acad-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </summary>
            <div class="acad-cat-body">
              <details class="acad-topic">
                <summary class="acad-topic-summary">Algorithms <span class="acad-count">12</span></summary>
                <ul class="acad-article-list">
                  <li><a href="#" class="acad-article-link">Sorting Algorithms</a></li>
                  <li><a href="#" class="acad-article-link">Graph Traversal</a></li>
                  <li><a href="#" class="acad-article-link">Dynamic Programming</a></li>
                </ul>
              </details>
            </div>
          </details>
        </div>
      </nav>
    </aside>

    <!-- ================================================================
         RIGHT SIDEBAR - Paper Outline / TOC with Section Numbers
         ================================================================ -->
    <aside class="acad-sidebar acad-sidebar-right" id="sidebar-right" aria-label="Table of contents">
      <div class="acad-sidebar-header">
        <span class="acad-sidebar-title">Paper Outline</span>
        <button type="button" class="acad-sidebar-close" aria-label="Close table of contents">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <nav class="acad-sidebar-body acad-toc-nav">
        <ol class="acad-toc-list">
          <li>
            <a href="#overview" class="acad-toc-link acad-toc-h2">
              <span class="acad-toc-num">1.</span> Overview
            </a>
          </li>
          <li>
            <a href="#the-consensus-problem" class="acad-toc-link acad-toc-h2">
              <span class="acad-toc-num">2.</span> The Consensus Problem
            </a>
            <ol class="acad-toc-sublist">
              <li>
                <a href="#why-consensus-matters" class="acad-toc-link acad-toc-h3">
                  <span class="acad-toc-num">2.1</span> Why Consensus Matters
                </a>
              </li>
              <li>
                <a href="#flp-impossibility" class="acad-toc-link acad-toc-h3">
                  <span class="acad-toc-num">2.2</span> FLP Impossibility
                </a>
              </li>
            </ol>
          </li>
          <li>
            <a href="#paxos-algorithm" class="acad-toc-link acad-toc-h2">
              <span class="acad-toc-num">3.</span> Paxos Algorithm
            </a>
            <ol class="acad-toc-sublist">
              <li>
                <a href="#paxos-phases" class="acad-toc-link acad-toc-h3">
                  <span class="acad-toc-num">3.1</span> Phases of Paxos
                </a>
              </li>
              <li>
                <a href="#multi-paxos" class="acad-toc-link acad-toc-h3">
                  <span class="acad-toc-num">3.2</span> Multi-Paxos
                </a>
              </li>
            </ol>
          </li>
          <li>
            <a href="#raft-consensus" class="acad-toc-link acad-toc-h2">
              <span class="acad-toc-num">4.</span> Raft Consensus
            </a>
            <ol class="acad-toc-sublist">
              <li>
                <a href="#leader-election" class="acad-toc-link acad-toc-h3">
                  <span class="acad-toc-num">4.1</span> Leader Election
                </a>
              </li>
              <li>
                <a href="#log-replication" class="acad-toc-link acad-toc-h3">
                  <span class="acad-toc-num">4.2</span> Log Replication
                </a>
              </li>
            </ol>
          </li>
          <li>
            <a href="#comparison" class="acad-toc-link acad-toc-h2">
              <span class="acad-toc-num">5.</span> Comparison
            </a>
          </li>
          <li>
            <a href="#appendix" class="acad-toc-link acad-toc-h2">
              <span class="acad-toc-num">6.</span> Appendix
            </a>
          </li>
        </ol>
      </nav>
    </aside>

    <!-- ================================================================
         MAIN CONTENT
         ================================================================ -->
    <main id="main-content" class="acad-main">
      <article class="acad-article">
        <!-- Breadcrumb -->
        <nav class="acad-breadcrumb" aria-label="Breadcrumb">
          <a href="/articles">Papers</a>
          <span class="acad-breadcrumb-sep">&rsaquo;</span>
          <a href="#">System Design</a>
          <span class="acad-breadcrumb-sep">&rsaquo;</span>
          <a href="#">Fundamentals</a>
        </nav>

        <!-- Article Header - Academic paper style -->
        <header class="acad-article-header">
          <div class="acad-article-meta-top">
            <span class="acad-subject-label">System Design</span>
            <span class="acad-meta-dot">&middot;</span>
            <span class="acad-subject-label">Fundamentals</span>
          </div>
          <h1 class="acad-article-title">Understanding Distributed Consensus Algorithms</h1>
          <p class="acad-article-subtitle">
            How systems like Paxos and Raft enable multiple nodes to agree on a single value, even in the presence of failures.
          </p>
          <div class="acad-article-meta-bottom">
            <span class="acad-author">Sujeet Kumar</span>
            <span class="acad-meta-dot">&middot;</span>
            <time datetime="2024-11-15">November 15, 2024</time>
            <span class="acad-meta-dot">&middot;</span>
            <span>18 min read</span>
          </div>
        </header>

        <div class="acad-rule" aria-hidden="true">
          <span></span><span></span><span></span>
        </div>

        <!-- Article Body -->
        <div class="acad-prose">
          <!-- Section 1 -->
          <h2 id="overview"><span class="acad-section-num">1.</span> Overview</h2>
          <p class="acad-dropcap">
            Distributed consensus is the cornerstone of reliable distributed systems. When multiple computers
            need to work together, they must agree on shared state despite network partitions, message delays,
            and node failures. This article explores the fundamental algorithms that make this possible.
          </p>
          <p>
            The challenge of achieving consensus has been studied extensively since the 1980s. From Leslie
            Lamport's pioneering work on Paxos to Diego Ongaro's more approachable Raft algorithm, the field
            has evolved to provide practical solutions for real-world systems like etcd, ZooKeeper, and
            CockroachDB.<sup class="acad-fn-ref"><a href="#fn-1" id="fn-ref-1">1</a></sup>
          </p>

          <blockquote>
            <p>A distributed system is one in which the failure of a computer you didn't even know existed can render your own computer unusable.</p>
            <cite>&mdash; Leslie Lamport</cite>
          </blockquote>

          <!-- Margin note example -->
          <div class="acad-margin-note-container">
            <p>
              The key insight behind all consensus protocols is that agreement among a majority of nodes
              is sufficient to make progress, even when some nodes have failed.<sup class="acad-fn-ref"><a href="#fn-2" id="fn-ref-2">2</a></sup>
            </p>
            <aside class="acad-margin-note" aria-label="Margin note">
              A majority quorum of <em>n</em> nodes requires at least &lfloor;<em>n</em>/2&rfloor; + 1
              responses. This is why consensus clusters typically use an odd number of nodes (3, 5, 7).
            </aside>
          </div>

          <!-- Section 2 -->
          <h2 id="the-consensus-problem"><span class="acad-section-num">2.</span> The Consensus Problem</h2>
          <p>
            At its core, the consensus problem requires a group of processes to agree on a single value.
            This sounds simple, but becomes remarkably difficult when processes can fail and messages can
            be lost or delayed.
          </p>

          <h3 id="why-consensus-matters"><span class="acad-section-num">2.1</span> Why Consensus Matters</h3>
          <p>
            Consensus is essential for many distributed systems primitives including leader election,
            atomic broadcast, state machine replication, and distributed locking.
          </p>
          <ul>
            <li><strong>Leader Election</strong> &mdash; Selecting a single coordinator among replicas</li>
            <li><strong>State Machine Replication</strong> &mdash; Keeping multiple copies of data consistent</li>
            <li><strong>Distributed Transactions</strong> &mdash; Ensuring atomicity across partitions</li>
            <li><strong>Configuration Management</strong> &mdash; Agreeing on cluster membership</li>
          </ul>

          <h3 id="flp-impossibility"><span class="acad-section-num">2.2</span> FLP Impossibility</h3>
          <p>
            The Fischer, Lynch, and Paterson impossibility result (1985) proves that no deterministic
            algorithm can guarantee consensus in an asynchronous system where even one process may crash.
            This foundational result shapes how all practical consensus algorithms are designed.<sup class="acad-fn-ref"><a href="#fn-3" id="fn-ref-3">3</a></sup>
          </p>

          <table>
            <thead>
              <tr>
                <th>Property</th>
                <th>Description</th>
                <th>Implication</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Agreement</td>
                <td>All correct processes decide the same value</td>
                <td>No split-brain scenarios</td>
              </tr>
              <tr>
                <td>Validity</td>
                <td>The decided value was proposed by some process</td>
                <td>No fabricated values</td>
              </tr>
              <tr>
                <td>Termination</td>
                <td>Every correct process eventually decides</td>
                <td>No infinite waiting</td>
              </tr>
            </tbody>
          </table>

          <!-- Section 3 -->
          <h2 id="paxos-algorithm"><span class="acad-section-num">3.</span> Paxos Algorithm</h2>
          <div class="acad-margin-note-container">
            <p>
              Paxos, introduced by Leslie Lamport in 1989, was the first practical consensus algorithm.
              Despite its reputation for difficulty, the core idea is elegant: a proposer must convince
              a majority of acceptors before a value is chosen.<sup class="acad-fn-ref"><a href="#fn-4" id="fn-ref-4">4</a></sup>
            </p>
            <aside class="acad-margin-note" aria-label="Margin note">
              Lamport originally described Paxos using a metaphor of a parliamentary system on the
              fictional Greek island of Paxos. The paper was famously rejected for years before publication.
            </aside>
          </div>

          <h3 id="paxos-phases"><span class="acad-section-num">3.1</span> Phases of Paxos</h3>
          <p>The basic Paxos protocol operates in two phases:</p>
          <ol>
            <li><strong>Prepare Phase</strong> &mdash; A proposer sends a prepare request with a unique proposal number to a majority of acceptors.</li>
            <li><strong>Accept Phase</strong> &mdash; If a majority responds, the proposer sends an accept request with the value.</li>
          </ol>

          <pre><code>// Simplified Paxos proposer logic
async function propose(value: string, acceptors: Acceptor[]) {'{'}
  const proposalId = generateUniqueId();
  const majority = Math.floor(acceptors.length / 2) + 1;

  // Phase 1: Prepare
  const promises = await Promise.all(
    acceptors.map(a =&gt; a.prepare(proposalId))
  );
  const accepted = promises.filter(p =&gt; p.ok);

  if (accepted.length {'<'} majority) {'{'}
    throw new Error('Failed to get majority in prepare phase');
  {'}'}

  // Phase 2: Accept
  const finalValue = getHighestAcceptedValue(accepted) || value;
  const acks = await Promise.all(
    acceptors.map(a =&gt; a.accept(proposalId, finalValue))
  );

  return acks.filter(a =&gt; a.ok).length >= majority;
{'}'}</code></pre>

          <h3 id="multi-paxos"><span class="acad-section-num">3.2</span> Multi-Paxos</h3>
          <p>
            Basic Paxos requires two round-trips for each consensus decision. Multi-Paxos optimizes this
            by electing a stable leader that can skip the prepare phase for subsequent proposals, reducing
            latency to a single round-trip in the common case.
          </p>

          <!-- Section 4 -->
          <h2 id="raft-consensus"><span class="acad-section-num">4.</span> Raft Consensus</h2>
          <p>
            Raft was designed by Diego Ongaro and John Ousterhout in 2014 as a more understandable
            alternative to Paxos. It decomposes consensus into three sub-problems: leader election,
            log replication, and safety.<sup class="acad-fn-ref"><a href="#fn-5" id="fn-ref-5">5</a></sup>
          </p>

          <h3 id="leader-election"><span class="acad-section-num">4.1</span> Leader Election</h3>
          <p>
            Raft uses randomized timeouts to trigger elections. When a follower doesn't hear from a leader
            within its timeout period, it becomes a candidate and requests votes from other nodes.
          </p>

          <h3 id="log-replication"><span class="acad-section-num">4.2</span> Log Replication</h3>
          <div class="acad-margin-note-container">
            <p>
              Once elected, the leader accepts client requests and replicates log entries to followers.
              An entry is considered committed when a majority of nodes have acknowledged it.
            </p>
            <aside class="acad-margin-note" aria-label="Margin note">
              The commit index advances monotonically. A leader never overwrites or deletes entries in
              its log; it only appends new entries.
            </aside>
          </div>

          <figure>
            <div class="acad-placeholder-diagram" role="img" aria-label="Raft log replication diagram">
              <span class="acad-diagram-title">Figure 1: Raft Log Replication Flow</span>
              <div class="acad-diagram-nodes">
                <div class="acad-diagram-node acad-diagram-leader">Leader</div>
                <div class="acad-diagram-arrows">
                  <span>&rarr;</span><span>&rarr;</span><span>&rarr;</span>
                </div>
                <div class="acad-diagram-node">Follower 1</div>
                <div class="acad-diagram-node">Follower 2</div>
                <div class="acad-diagram-node">Follower 3</div>
              </div>
            </div>
            <figcaption>Figure 1. Leader replicates log entries to all followers. Entry is committed after majority acknowledgment.</figcaption>
          </figure>

          <!-- Section 5 -->
          <h2 id="comparison"><span class="acad-section-num">5.</span> Comparison</h2>
          <p>
            While both Paxos and Raft solve the same fundamental problem, they differ significantly
            in their approach to understandability, implementation complexity, and operational behavior.
          </p>

          <table>
            <thead>
              <tr>
                <th>Aspect</th>
                <th>Paxos</th>
                <th>Raft</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Understandability</td>
                <td>Complex, academic</td>
                <td>Designed for clarity</td>
              </tr>
              <tr>
                <td>Leader requirement</td>
                <td>Optional (Multi-Paxos)</td>
                <td>Required (strong leader)</td>
              </tr>
              <tr>
                <td>Log ordering</td>
                <td>Allows gaps</td>
                <td>Strict sequential</td>
              </tr>
              <tr>
                <td>Used in</td>
                <td>Chubby, Spanner</td>
                <td>etcd, CockroachDB</td>
              </tr>
            </tbody>
          </table>

          <!-- Section 6 -->
          <h2 id="appendix"><span class="acad-section-num">6.</span> Appendix</h2>
          <h3><span class="acad-section-num">6.1</span> Prerequisites</h3>
          <ul>
            <li>Understanding of distributed systems fundamentals</li>
            <li>Familiarity with client-server architecture</li>
            <li>Basic knowledge of fault tolerance concepts</li>
          </ul>
          <h3><span class="acad-section-num">6.2</span> Summary</h3>
          <p>
            Distributed consensus enables reliable systems by allowing multiple nodes to agree on shared state.
            Paxos pioneered the field but is complex to understand. Raft provides equivalent guarantees with
            a clearer structure. Modern systems like etcd and CockroachDB rely on Raft for their consensus layer.
          </p>

          <!-- Footnotes / References -->
          <div class="acad-rule" aria-hidden="true">
            <span></span><span></span><span></span>
          </div>

          <h3><span class="acad-section-num">6.3</span> Notes &amp; References</h3>
          <ol class="acad-footnotes">
            <li id="fn-1">
              <a href="#fn-ref-1" class="acad-fn-back" aria-label="Back to reference 1">&uarr;</a>
              Lamport, L. "The Part-Time Parliament." <em>ACM Transactions on Computer Systems</em>, 16(2):133&ndash;169, 1998.
            </li>
            <li id="fn-2">
              <a href="#fn-ref-2" class="acad-fn-back" aria-label="Back to reference 2">&uarr;</a>
              The quorum intersection property ensures that any two majorities share at least one member, preventing conflicting decisions.
            </li>
            <li id="fn-3">
              <a href="#fn-ref-3" class="acad-fn-back" aria-label="Back to reference 3">&uarr;</a>
              Fischer, M., Lynch, N., Paterson, M. "Impossibility of Distributed Consensus with One Faulty Process." <em>Journal of the ACM</em>, 32(2):374&ndash;382, 1985.
            </li>
            <li id="fn-4">
              <a href="#fn-ref-4" class="acad-fn-back" aria-label="Back to reference 4">&uarr;</a>
              Lamport, L. "Paxos Made Simple." <em>ACM SIGACT News</em>, 32(4):18&ndash;25, 2001.
            </li>
            <li id="fn-5">
              <a href="#fn-ref-5" class="acad-fn-back" aria-label="Back to reference 5">&uarr;</a>
              Ongaro, D. &amp; Ousterhout, J. "In Search of an Understandable Consensus Algorithm." <em>Proceedings of USENIX ATC</em>, 2014.
            </li>
          </ol>
        </div>

        <!-- Article Navigation -->
        <div class="acad-rule" aria-hidden="true">
          <span></span><span></span><span></span>
        </div>
        <nav class="acad-article-nav" aria-label="Article navigation">
          <a href="#" class="acad-nav-prev">
            <span class="acad-nav-label">Previous Paper</span>
            <span class="acad-nav-title">CAP Theorem and Consistency Models</span>
          </a>
          <a href="#" class="acad-nav-next">
            <span class="acad-nav-label">Next Paper</span>
            <span class="acad-nav-title">Time and Ordering in Distributed Systems</span>
          </a>
        </nav>
      </article>
    </main>
  </body>
</html>

<style is:global>
  /* ================================================================
     DESIGN 5: ACADEMIC PAPER
     Scholarly typography, footnote-style TOC, margin notes, serif elegance
     EB Garamond (body/headings) + Inconsolata (code/mono)
     ================================================================ */

  /* --- Reset --- */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  /* --- Design Tokens --- */
  :root {
    --acad-bg: #FFFEF5;
    --acad-bg-alt: #F8F5EC;
    --acad-bg-elevated: #FFFEF8;
    --acad-text: #333333;
    --acad-text-secondary: #4A4A4A;
    --acad-text-muted: #7A7060;
    --acad-accent: #1B2A4A;
    --acad-accent-hover: #0F1B33;
    --acad-accent-subtle: rgba(27, 42, 74, 0.06);
    --acad-secondary: #6B4C3B;
    --acad-secondary-subtle: rgba(107, 76, 59, 0.08);
    --acad-border: #E8E0D0;
    --acad-border-subtle: #EDE7DA;
    --acad-code-bg: #F5F1E8;

    --acad-font-serif: 'EB Garamond', 'Georgia', 'Times New Roman', serif;
    --acad-font-mono: 'Inconsolata', 'Courier New', monospace;
    --acad-font-ui: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

    --acad-content-width: 680px;
    --acad-sidebar-width: 280px;
    --acad-header-height: 52px;
    --acad-transition: 250ms cubic-bezier(0.4, 0, 0.2, 1);
    --acad-transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* --- Base --- */
  html {
    scroll-behavior: smooth;
    scroll-padding-top: calc(var(--acad-header-height) + 2rem);
  }
  body {
    font-family: var(--acad-font-serif);
    font-size: 19px;
    line-height: 1.9;
    color: var(--acad-text);
    background: var(--acad-bg);
    -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
    /* Subtle paper texture/grain using CSS noise */
    background-image:
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  }

  /* --- Skip Link --- */
  .acad-skip-link {
    position: absolute; top: 0; left: 0; z-index: 200;
    padding: 8px 16px;
    background: var(--acad-accent); color: #FFFEF5;
    font-family: var(--acad-font-ui); font-size: 14px;
    text-decoration: none;
    transform: translateY(-100%);
    transition: transform var(--acad-transition-fast);
  }
  .acad-skip-link:focus { transform: translateY(0); }

  /* ================================================================
     HEADER - Minimal, almost invisible thin-line
     ================================================================ */
  .acad-header {
    position: sticky; top: 0; z-index: 50;
    height: var(--acad-header-height);
    background: rgba(255, 254, 245, 0.9);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid var(--acad-border-subtle);
  }
  .acad-header-inner {
    display: flex; align-items: center; justify-content: space-between;
    max-width: 1200px; margin: 0 auto;
    padding: 0 20px; height: 100%;
  }
  .acad-logo {
    font-family: var(--acad-font-serif);
    font-size: 20px; font-weight: 500;
    color: var(--acad-accent); text-decoration: none;
    letter-spacing: 0.01em;
  }
  .acad-logo-dot { color: var(--acad-secondary); }
  .acad-header-actions { display: flex; align-items: center; gap: 4px; }
  .acad-header-btn {
    display: flex; align-items: center; justify-content: center;
    width: 44px; height: 44px;
    background: none; border: none; cursor: pointer;
    color: var(--acad-text-muted); border-radius: 4px;
    transition: all var(--acad-transition-fast);
  }
  .acad-header-btn:hover { background: var(--acad-accent-subtle); color: var(--acad-accent); }
  .acad-header-btn[aria-expanded="true"] { color: var(--acad-accent); background: var(--acad-accent-subtle); }

  /* ================================================================
     BACKDROP
     ================================================================ */
  .acad-backdrop {
    position: fixed; inset: 0; z-index: 59;
    background: rgba(27, 42, 74, 0.18);
    backdrop-filter: blur(2px);
    opacity: 0; pointer-events: none;
    transition: opacity var(--acad-transition);
  }
  .acad-backdrop.is-visible { opacity: 1; pointer-events: auto; }

  /* ================================================================
     SIDEBARS (shared)
     ================================================================ */
  .acad-sidebar {
    position: fixed; top: 0; z-index: 60;
    width: var(--acad-sidebar-width);
    height: 100vh; height: 100dvh;
    background: var(--acad-bg-elevated);
    display: flex; flex-direction: column;
    transition: transform var(--acad-transition);
    overflow: hidden;
    border-color: var(--acad-border);
  }
  .acad-sidebar-left {
    left: 0; border-right: 1px solid var(--acad-border);
    transform: translateX(-100%);
    box-shadow: 2px 0 20px rgba(27, 42, 74, 0.08);
  }
  .acad-sidebar-left.is-open { transform: translateX(0); }

  .acad-sidebar-right {
    right: 0; border-left: 1px solid var(--acad-border);
    transform: translateX(100%);
    box-shadow: -2px 0 20px rgba(27, 42, 74, 0.08);
  }
  .acad-sidebar-right.is-open { transform: translateX(0); }

  .acad-sidebar-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--acad-border);
    flex-shrink: 0;
  }
  .acad-sidebar-title {
    font-family: var(--acad-font-serif);
    font-size: 13px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.15em;
    color: var(--acad-secondary);
    font-variant: small-caps;
  }
  .acad-sidebar-close {
    display: flex; align-items: center; justify-content: center;
    width: 36px; height: 36px;
    background: none; border: none; cursor: pointer;
    color: var(--acad-text-muted); border-radius: 4px;
    transition: all var(--acad-transition-fast);
  }
  .acad-sidebar-close:hover { background: var(--acad-accent-subtle); color: var(--acad-accent); }
  .acad-sidebar-body { flex: 1; overflow-y: auto; padding: 16px 0; }

  /* --- Left Sidebar: Library/Catalog Nav --- */
  .acad-nav-section { padding: 0 12px 12px; }
  .acad-nav-link {
    display: block; padding: 8px 14px;
    font-family: var(--acad-font-serif);
    font-size: 15px; font-weight: 400;
    color: var(--acad-text); text-decoration: none;
    border-radius: 3px;
    transition: all var(--acad-transition-fast);
    letter-spacing: 0.02em;
  }
  .acad-nav-link:hover { background: var(--acad-accent-subtle); color: var(--acad-accent); }
  .acad-nav-divider {
    height: 1px; margin: 8px 20px;
    background: var(--acad-border);
  }

  /* --- Browse Section --- */
  .acad-browse { padding: 0 12px; }
  .acad-browse-label {
    display: block; padding: 8px 14px;
    font-family: var(--acad-font-serif);
    font-size: 12px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.18em;
    color: var(--acad-secondary);
    font-variant: small-caps;
  }

  /* Category accordion */
  .acad-cat { border: none; }
  .acad-cat-summary {
    display: flex; align-items: center; justify-content: space-between;
    padding: 7px 14px; cursor: pointer;
    list-style: none; border-radius: 3px;
    transition: background var(--acad-transition-fast);
  }
  .acad-cat-summary::-webkit-details-marker { display: none; }
  .acad-cat-summary:hover { background: var(--acad-accent-subtle); }
  .acad-cat-name {
    font-family: var(--acad-font-serif);
    font-size: 14px; font-weight: 600;
    color: var(--acad-accent);
    font-variant: small-caps;
    letter-spacing: 0.04em;
  }
  .acad-chevron {
    color: var(--acad-text-muted);
    transition: transform var(--acad-transition);
    flex-shrink: 0;
  }
  .acad-cat[open] > .acad-cat-summary .acad-chevron { transform: rotate(180deg); }
  .acad-cat-body { padding: 0 0 4px 10px; }

  /* Topic accordion */
  .acad-topic { border: none; }
  .acad-topic-summary {
    display: flex; align-items: center; gap: 8px;
    padding: 5px 14px; cursor: pointer;
    list-style: none; border-radius: 3px;
    font-family: var(--acad-font-serif);
    font-size: 13px; font-weight: 500;
    color: var(--acad-text-secondary);
    transition: all var(--acad-transition-fast);
  }
  .acad-topic-summary::-webkit-details-marker { display: none; }
  .acad-topic-summary:hover { background: var(--acad-accent-subtle); color: var(--acad-accent); }
  .acad-count {
    font-family: var(--acad-font-mono);
    font-size: 10px; color: var(--acad-text-muted);
    background: var(--acad-bg-alt); padding: 1px 6px;
    border-radius: 2px;
  }

  /* Article links in sidebar */
  .acad-article-list { list-style: none; padding: 2px 0 2px 14px; }
  .acad-article-link {
    display: block; padding: 4px 14px;
    font-family: var(--acad-font-serif);
    font-size: 13px; color: var(--acad-text-muted);
    text-decoration: none; border-radius: 3px;
    transition: all var(--acad-transition-fast);
    border-left: 2px solid transparent;
  }
  .acad-article-link:hover { color: var(--acad-accent); background: var(--acad-accent-subtle); }
  .acad-article-link--active {
    color: var(--acad-accent) !important;
    border-left-color: var(--acad-accent);
    background: var(--acad-accent-subtle);
    font-weight: 500;
  }

  /* ================================================================
     RIGHT SIDEBAR - Paper Outline TOC with Section Numbers
     ================================================================ */
  .acad-toc-nav { padding: 12px; }
  .acad-toc-list, .acad-toc-sublist { list-style: none; }
  .acad-toc-list { padding: 0; counter-reset: none; }
  .acad-toc-sublist {
    padding: 2px 0 6px 20px;
    border-left: 1px solid var(--acad-border);
  }
  .acad-toc-link {
    display: flex; align-items: baseline; gap: 6px;
    padding: 5px 10px;
    font-family: var(--acad-font-serif);
    text-decoration: none; border-radius: 3px;
    transition: all var(--acad-transition-fast);
  }
  .acad-toc-num {
    font-family: var(--acad-font-mono);
    font-size: 11px;
    color: var(--acad-secondary);
    flex-shrink: 0;
    min-width: 24px;
  }
  .acad-toc-h2 {
    font-size: 14px; font-weight: 500; color: var(--acad-accent);
  }
  .acad-toc-h3 {
    font-size: 13px; font-weight: 400; color: var(--acad-text-muted);
  }
  .acad-toc-link:hover { background: var(--acad-accent-subtle); color: var(--acad-accent); }
  .acad-toc-link:hover .acad-toc-num { color: var(--acad-accent); }

  /* ================================================================
     MAIN CONTENT - Always Centered
     ================================================================ */
  .acad-main {
    max-width: var(--acad-content-width);
    margin: 0 auto;
    padding: 0 24px calc(var(--acad-header-height) + 80px);
  }

  /* --- Breadcrumb --- */
  .acad-breadcrumb {
    display: flex; align-items: center; gap: 6px;
    padding: 24px 0 8px;
    font-family: var(--acad-font-serif);
    font-size: 13px;
    font-variant: small-caps;
    letter-spacing: 0.05em;
  }
  .acad-breadcrumb a {
    color: var(--acad-text-muted); text-decoration: none;
    transition: color var(--acad-transition-fast);
  }
  .acad-breadcrumb a:hover { color: var(--acad-accent); }
  .acad-breadcrumb-sep { color: var(--acad-border); font-size: 16px; }

  /* --- Article Header --- */
  .acad-article-header { padding: 40px 0 0; text-align: center; }
  .acad-article-meta-top {
    display: flex; align-items: center; justify-content: center; gap: 10px;
    font-family: var(--acad-font-serif);
    font-size: 13px; font-weight: 500;
    color: var(--acad-text-muted);
    margin-bottom: 24px;
  }
  .acad-subject-label {
    font-variant: small-caps;
    letter-spacing: 0.12em;
    text-transform: lowercase;
    color: var(--acad-secondary);
  }
  .acad-meta-dot { color: var(--acad-border); }
  .acad-article-title {
    font-family: var(--acad-font-serif);
    font-size: clamp(28px, 4.5vw, 42px);
    font-weight: 500; line-height: 1.2;
    color: var(--acad-accent);
    letter-spacing: -0.01em;
    margin-bottom: 20px;
  }
  .acad-article-subtitle {
    font-family: var(--acad-font-serif);
    font-size: 18px; line-height: 1.7;
    color: var(--acad-text-muted);
    font-style: italic;
    max-width: 560px; margin: 0 auto 20px;
  }
  .acad-article-meta-bottom {
    display: flex; align-items: center; justify-content: center; gap: 10px;
    font-family: var(--acad-font-serif);
    font-size: 14px; color: var(--acad-text-muted);
    font-variant: small-caps;
    letter-spacing: 0.04em;
  }
  .acad-author {
    font-weight: 500;
    color: var(--acad-text-secondary);
  }

  /* --- Ornamental Rule (three dots) --- */
  .acad-rule {
    display: flex; align-items: center; justify-content: center; gap: 12px;
    margin: 36px auto;
    height: 20px;
  }
  .acad-rule span {
    display: block; width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--acad-border);
  }
  .acad-rule span:nth-child(2) {
    width: 6px; height: 6px;
    background: var(--acad-secondary);
    opacity: 0.5;
  }

  /* ================================================================
     PROSE CONTENT - Academic scholarly style
     ================================================================ */
  .acad-prose { padding: 8px 0 48px; }

  /* Section number styling */
  .acad-section-num {
    font-family: var(--acad-font-mono);
    font-size: 0.8em;
    color: var(--acad-secondary);
    margin-right: 6px;
    font-weight: 400;
  }

  .acad-prose h2 {
    font-family: var(--acad-font-serif);
    font-size: clamp(22px, 3vw, 28px);
    font-weight: 600; line-height: 1.3;
    color: var(--acad-accent);
    margin: 56px 0 18px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--acad-border);
  }
  .acad-prose h3 {
    font-family: var(--acad-font-serif);
    font-size: clamp(18px, 2.5vw, 22px);
    font-weight: 500; line-height: 1.4;
    color: var(--acad-accent);
    margin: 40px 0 12px;
    font-style: italic;
  }
  .acad-prose p { margin-bottom: 22px; }
  .acad-prose a {
    color: var(--acad-accent); text-decoration: none;
    border-bottom: 1px solid var(--acad-secondary);
    transition: border-color var(--acad-transition-fast);
  }
  .acad-prose a:hover { border-bottom-color: var(--acad-accent); border-bottom-width: 2px; }

  /* Drop cap - elegant serif */
  .acad-dropcap::first-letter {
    float: left;
    font-family: var(--acad-font-serif);
    font-size: 5rem; line-height: 0.78;
    font-weight: 400;
    color: var(--acad-accent);
    margin: 6px 14px 0 -4px;
    padding-top: 4px;
  }

  /* Blockquote - academic: large left margin, no border, italic serif */
  .acad-prose blockquote {
    margin: 40px 0 40px 48px;
    padding: 0 16px;
    border: none;
    font-style: italic;
    font-size: 18px;
    line-height: 1.8;
  }
  .acad-prose blockquote p {
    margin-bottom: 8px;
    color: var(--acad-text-secondary);
  }
  .acad-prose blockquote cite {
    font-size: 14px; color: var(--acad-text-muted);
    font-style: normal;
    font-variant: small-caps;
    letter-spacing: 0.05em;
  }

  /* Lists */
  .acad-prose ul, .acad-prose ol { margin: 20px 0; padding-left: 32px; }
  .acad-prose li { margin-bottom: 8px; line-height: 1.8; }
  .acad-prose li strong { color: var(--acad-accent); font-weight: 600; }

  /* Tables - classic academic: top/bottom rules, no vertical lines */
  .acad-prose table {
    width: 100%; margin: 32px 0; border-collapse: collapse;
    font-size: 16px; line-height: 1.6;
  }
  .acad-prose thead {
    border-top: 2px solid var(--acad-accent);
    border-bottom: 1px solid var(--acad-accent);
  }
  .acad-prose th {
    font-family: var(--acad-font-serif);
    font-size: 14px; font-weight: 600;
    font-variant: small-caps;
    letter-spacing: 0.06em;
    color: var(--acad-accent);
    text-align: left; padding: 10px 16px;
  }
  .acad-prose td {
    padding: 10px 16px;
    color: var(--acad-text-secondary);
    border: none;
  }
  .acad-prose tbody { border-bottom: 2px solid var(--acad-accent); }
  .acad-prose tbody tr:not(:last-child) td {
    border-bottom: 1px solid var(--acad-border-subtle);
  }

  /* Code */
  .acad-prose code {
    font-family: var(--acad-font-mono);
    font-size: 15px;
    background: var(--acad-code-bg); padding: 2px 6px;
    border-radius: 2px;
    color: var(--acad-secondary);
  }
  .acad-prose pre {
    margin: 32px 0; padding: 24px;
    background: var(--acad-code-bg);
    border-radius: 3px;
    border-top: 2px solid var(--acad-border);
    border-bottom: 2px solid var(--acad-border);
    overflow-x: auto; font-size: 14px; line-height: 1.7;
  }
  .acad-prose pre code {
    background: none; padding: 0;
    font-size: inherit; color: var(--acad-text);
  }

  /* Footnote references (superscript) */
  .acad-fn-ref {
    font-family: var(--acad-font-mono);
    font-size: 12px;
    line-height: 0;
    vertical-align: super;
  }
  .acad-fn-ref a {
    color: var(--acad-secondary);
    text-decoration: none;
    border: none !important;
    padding: 0 2px;
    transition: color var(--acad-transition-fast);
  }
  .acad-fn-ref a:hover { color: var(--acad-accent); }

  /* Footnotes section */
  .acad-footnotes {
    list-style: none; padding: 0; margin: 20px 0 0;
    counter-reset: fn-counter;
    font-size: 15px; line-height: 1.7;
    color: var(--acad-text-secondary);
  }
  .acad-footnotes li {
    counter-increment: fn-counter;
    position: relative;
    padding: 6px 0 6px 36px;
    margin-bottom: 4px;
    border-bottom: 1px solid var(--acad-border-subtle);
  }
  .acad-footnotes li:last-child { border-bottom: none; }
  .acad-footnotes li::before {
    content: counter(fn-counter) ".";
    position: absolute; left: 0; top: 6px;
    font-family: var(--acad-font-mono);
    font-size: 12px;
    color: var(--acad-secondary);
    font-weight: 500;
  }
  .acad-fn-back {
    font-family: var(--acad-font-mono);
    font-size: 12px;
    color: var(--acad-secondary) !important;
    text-decoration: none !important;
    border: none !important;
    margin-right: 6px;
  }
  .acad-fn-back:hover { color: var(--acad-accent) !important; }

  /* Margin notes */
  .acad-margin-note-container {
    position: relative;
  }
  .acad-margin-note {
    display: none; /* Hidden by default, shown on wide screens */
    font-family: var(--acad-font-serif);
    font-size: 13px; line-height: 1.6;
    color: var(--acad-text-muted);
    font-style: italic;
    padding: 8px 0 8px 16px;
    border-left: 1px solid var(--acad-border);
  }

  /* Show margin notes on wide screens */
  @media (min-width: 1200px) {
    .acad-margin-note-container {
      position: relative;
    }
    .acad-margin-note {
      display: block;
      position: absolute;
      right: -240px;
      top: 0;
      width: 200px;
      padding: 0 0 0 16px;
      border-left: 1px solid var(--acad-border);
    }
  }

  /* Figure/Diagram placeholder */
  .acad-placeholder-diagram {
    margin: 32px 0; padding: 40px;
    background: var(--acad-bg-alt);
    border-top: 2px solid var(--acad-border);
    border-bottom: 2px solid var(--acad-border);
    text-align: center;
    font-family: var(--acad-font-serif); color: var(--acad-text-muted);
  }
  .acad-diagram-title {
    font-weight: 500; font-size: 14px;
    display: block; margin-bottom: 16px;
    font-variant: small-caps;
    letter-spacing: 0.06em;
    color: var(--acad-accent);
  }
  .acad-diagram-nodes {
    display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap;
  }
  .acad-diagram-node {
    padding: 8px 16px; background: var(--acad-bg-elevated);
    border: 1px solid var(--acad-border); border-radius: 3px;
    font-size: 13px; font-weight: 500;
    font-family: var(--acad-font-mono);
  }
  .acad-diagram-leader {
    background: var(--acad-accent); color: var(--acad-bg);
    border-color: var(--acad-accent);
  }
  .acad-diagram-arrows { color: var(--acad-secondary); font-size: 20px; display: flex; gap: 4px; }
  .acad-prose figcaption {
    text-align: center; font-size: 14px; font-style: italic;
    color: var(--acad-text-muted); margin-top: 12px;
    font-family: var(--acad-font-serif);
  }

  /* --- Article Navigation --- */
  .acad-article-nav {
    display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
    padding: 16px 0 48px;
  }
  .acad-nav-prev, .acad-nav-next {
    display: flex; flex-direction: column; gap: 4px;
    padding: 20px; border: 1px solid var(--acad-border);
    border-radius: 3px; text-decoration: none;
    transition: all var(--acad-transition);
  }
  .acad-nav-prev:hover, .acad-nav-next:hover {
    border-color: var(--acad-accent);
    background: var(--acad-accent-subtle);
  }
  .acad-nav-next { text-align: right; }
  .acad-nav-label {
    font-family: var(--acad-font-serif);
    font-size: 11px; font-weight: 500;
    text-transform: uppercase; letter-spacing: 0.12em;
    color: var(--acad-secondary);
    font-variant: small-caps;
  }
  .acad-nav-title {
    font-family: var(--acad-font-serif);
    font-size: 16px; font-weight: 500;
    color: var(--acad-accent); line-height: 1.4;
  }

  /* ================================================================
     RESPONSIVE
     ================================================================ */
  @media (max-width: 640px) {
    .acad-sidebar { width: min(85vw, 320px); }
    .acad-article-header { text-align: left; }
    .acad-article-meta-top { justify-content: flex-start; }
    .acad-article-meta-bottom { justify-content: flex-start; flex-wrap: wrap; }
    .acad-article-nav { grid-template-columns: 1fr; }
    .acad-main { padding: 0 16px 80px; }
    .acad-prose blockquote { margin-left: 20px; }
    .acad-dropcap::first-letter { font-size: 3.8rem; margin-right: 10px; }
  }

  /* ================================================================
     FOCUS STYLES
     ================================================================ */
  :focus-visible {
    outline: 2px solid var(--acad-accent);
    outline-offset: 2px;
  }
</style>

<script>
  function initAcademicLayout() {
    const toggleLeft = document.querySelector('.acad-toggle-left') as HTMLButtonElement | null;
    const toggleRight = document.querySelector('.acad-toggle-right') as HTMLButtonElement | null;
    const sidebarLeft = document.getElementById('sidebar-left');
    const sidebarRight = document.getElementById('sidebar-right');
    const backdrop = document.getElementById('sidebar-backdrop');

    function closeSidebars() {
      sidebarLeft?.classList.remove('is-open');
      sidebarRight?.classList.remove('is-open');
      backdrop?.classList.remove('is-visible');
      toggleLeft?.setAttribute('aria-expanded', 'false');
      toggleRight?.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = '';
    }

    function toggleSidebar(sidebar: HTMLElement | null, toggle: HTMLButtonElement | null) {
      if (!sidebar || !toggle) return;
      const isOpen = sidebar.classList.contains('is-open');
      closeSidebars();
      if (!isOpen) {
        sidebar.classList.add('is-open');
        backdrop?.classList.add('is-visible');
        toggle.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
      }
    }

    toggleLeft?.addEventListener('click', () => toggleSidebar(sidebarLeft, toggleLeft));
    toggleRight?.addEventListener('click', () => toggleSidebar(sidebarRight, toggleRight));
    backdrop?.addEventListener('click', closeSidebars);

    // Close buttons inside sidebars
    document.querySelectorAll('.acad-sidebar-close').forEach(btn => {
      btn.addEventListener('click', closeSidebars);
    });

    // Escape key closes sidebars
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSidebars();
    });

    // localStorage for sidebar state
    const STORAGE_KEY_LEFT = 'acad-sidebar-left';
    const STORAGE_KEY_RIGHT = 'acad-sidebar-right';

    // Restore saved state on desktop
    const isDesktop = window.matchMedia('(min-width: 1024px)').matches;
    if (isDesktop) {
      const savedLeft = localStorage.getItem(STORAGE_KEY_LEFT);
      const savedRight = localStorage.getItem(STORAGE_KEY_RIGHT);
      if (savedLeft === 'open') {
        sidebarLeft?.classList.add('is-open');
        toggleLeft?.setAttribute('aria-expanded', 'true');
      }
      if (savedRight === 'open') {
        sidebarRight?.classList.add('is-open');
        toggleRight?.setAttribute('aria-expanded', 'true');
      }
    }

    // Save state on toggle (desktop only)
    toggleLeft?.addEventListener('click', () => {
      if (window.matchMedia('(min-width: 1024px)').matches) {
        const isOpen = sidebarLeft?.classList.contains('is-open');
        localStorage.setItem(STORAGE_KEY_LEFT, isOpen ? 'open' : 'closed');
      }
    });
    toggleRight?.addEventListener('click', () => {
      if (window.matchMedia('(min-width: 1024px)').matches) {
        const isOpen = sidebarRight?.classList.contains('is-open');
        localStorage.setItem(STORAGE_KEY_RIGHT, isOpen ? 'open' : 'closed');
      }
    });
  }

  document.addEventListener('DOMContentLoaded', initAcademicLayout);
</script>
