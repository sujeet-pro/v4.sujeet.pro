---
import Layout from "@/layout/layout.astro"
import SidebarNavSite from "@/components/nav/sidebar-nav-site.astro"
import { getSearchFacets } from "@/utils/search.utils"
import { SEARCH_SCHEMA } from "@/utils/search.types"
import { Icon } from "astro-icon/components"
import { getFilePath } from "@/utils/link.utils"

// Get facet options at build time (with counts, sorted by count)
const { categories, topics } = await getSearchFacets()

// Serialize data for client-side script
const searchSchemaJson = JSON.stringify(SEARCH_SCHEMA)
const searchIndexPath = getFilePath("search/index.json")
---

<Layout title="Search" description="Search for articles on Sujeet's blog" crumbs={null} pageType="default" hasLeftSidebar={true}>
  <Fragment slot="sidebar-left">
    <!-- Navigation - only visible when header nav is hidden (below md) -->
    <div class="search-sidebar-nav">
      <SidebarNavSite />
    </div>

    <!-- Search Filters (always visible in sidebar) -->
    <div id="search-filters" class="search-sidebar-filters">
      <div class="sidebar-filters-header">
        <h2 class="sidebar-nav-title">Filters</h2>
        <button id="clear-filters" class="filters-clear-btn is-hidden" type="button">
          <Icon name="carbon:close" class="icon-sm" />
          <span>Clear</span>
        </button>
      </div>

      <div id="active-filters-display" class="sidebar-active-pills"></div>

      {
        categories.length > 0 && (
          <div class="filters-group">
            <span class="filters-group-label">Categories</span>
            <div class="filters-group-tags" id="category-filters">
              {categories.map((cat) => (
                <label class="filter-chip" title={cat.title} data-filter-id={cat.id}>
                  <input type="checkbox" name="category" value={cat.id} class="filter-chip-input" />
                  <span class="filter-chip-pill">
                    {cat.name}
                    <span class="filter-chip-count" data-count-for={cat.id}>
                      {cat.count}
                    </span>
                  </span>
                </label>
              ))}
            </div>
          </div>
        )
      }

      {
        topics.length > 0 && (
          <div class="filters-group">
            <span class="filters-group-label">Topics</span>
            <div class="filters-group-tags" id="topic-filters">
              {topics.map((topic) => (
                <label class="filter-chip" title={topic.title} data-filter-id={topic.id}>
                  <input type="checkbox" name="topic" value={topic.id} class="filter-chip-input" />
                  <span class="filter-chip-pill">
                    {topic.name}
                    <span class="filter-chip-count" data-count-for={topic.id}>
                      {topic.count}
                    </span>
                  </span>
                </label>
              ))}
            </div>
          </div>
        )
      }
    </div>
  </Fragment>

  <div class="search-page">
    <!-- Hero Section with Search -->
    <header class="search-hero">
      <h1 class="search-hero-title">Search</h1>
      <p class="search-hero-subtitle">Find articles across all categories and topics</p>

      <!-- Search Input -->
      <div class="search-box">
        <div class="search-box-inner">
          <Icon name="carbon:search" class="search-box-icon" />
          <input
            type="text"
            id="search-query"
            placeholder="What are you looking for?"
            class="search-box-input"
            autocomplete="off"
            autofocus
          />
          <kbd class="search-box-hint" id="search-hint">Enter</kbd>
        </div>
      </div>
    </header>

    <!-- Results Section -->
    <section class="search-results-section" aria-label="Search results">
      <div class="results-header">
        <p id="result-count" class="results-count is-hidden" aria-live="polite"></p>
      </div>

      <ul id="search-results" class="search-results-list">
        <li id="search-placeholder" class="search-empty-state">
          <div class="search-empty-content">
            <div class="search-empty-icon-wrapper">
              <Icon name="carbon:search-locate" class="search-empty-icon" />
            </div>
            <p class="search-empty-text">Loading articles...</p>
          </div>
        </li>
      </ul>
    </section>
  </div>

  <!-- Pass data to client via JSON script tags -->
  <script is:inline id="search-schema-data" type="application/json" set:html={searchSchemaJson} />
  <script is:inline id="search-index-path" type="application/json" set:html={JSON.stringify(searchIndexPath)} />
</Layout>

<script>
  import { initSearchPage } from "@/scripts/search-page"
  document.addEventListener("DOMContentLoaded", initSearchPage)
  document.addEventListener("astro:page-load", initSearchPage)
</script>

<style is:global>
  @reference "tailwindcss";

  /* ==========================================================================
     SEARCH PAGE - "Serene Scholar" Design System
     ========================================================================== */

  .search-page {
    @apply py-6;
  }

  /* ==========================================================================
     HERO SECTION
     ========================================================================== */

  .search-hero {
    @apply mb-12 text-center;
    animation: fadeInUp var(--transition-slow) forwards;
  }

  .search-hero-title {
    @apply mb-3 font-sans font-normal;
    font-size: clamp(36px, 6vw, 52px);
    line-height: 1.1;
    letter-spacing: -0.03em;
    color: var(--color-text);
  }

  .search-hero-subtitle {
    @apply mb-10;
    font-size: 18px;
    line-height: 1.6;
    color: var(--color-text-muted);
    animation: fadeInUp var(--transition-slow) 100ms forwards;
    opacity: 0;
  }

  /* ==========================================================================
     SEARCH BOX
     ========================================================================== */

  .search-box {
    @apply mx-auto;
    max-width: 600px;
    animation: fadeInUp var(--transition-slow) 150ms forwards;
    opacity: 0;
  }

  .search-box-inner {
    @apply relative flex items-center;
  }

  .search-box-icon {
    @apply absolute left-5 h-5 w-5;
    color: var(--color-text-muted);
    pointer-events: none;
    transition: color var(--transition-fast);
  }

  .search-box-input {
    @apply w-full rounded-2xl border-2 py-4 pr-20 pl-14 text-lg;
    border-color: var(--color-border);
    background: var(--color-bg-elevated);
    color: var(--color-text);
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-fast);
  }

  .search-box-input:focus {
    @apply outline-none;
    border-color: var(--color-accent);
    box-shadow:
      var(--shadow-md),
      0 0 0 4px var(--color-accent-subtle);
  }

  .search-box-input:focus ~ .search-box-icon {
    color: var(--color-accent);
  }

  .search-box-input::placeholder {
    color: var(--color-text-muted);
    font-weight: 400;
  }

  .search-box-hint {
    @apply absolute right-4 rounded-lg px-2.5 py-1.5 font-mono text-xs;
    background: var(--color-bg-alt);
    color: var(--color-text-muted);
    border: 1px solid var(--color-border-subtle);
    pointer-events: none;
    transition: opacity var(--transition-fast);
  }

  .search-box-hint.is-hidden {
    opacity: 0;
  }

  /* ==========================================================================
     SIDEBAR - NAVIGATION & FILTERS
     ========================================================================== */

  /* Hide sidebar nav when header nav links are visible (md+) */
  .search-sidebar-nav {
    @apply md:hidden;
    @apply mb-6;
  }

  /* Sidebar filters container */
  .search-sidebar-filters {
    @apply flex flex-col gap-3;
  }

  .sidebar-filters-header {
    @apply flex items-center justify-between gap-2;
  }

  .sidebar-filters-header .sidebar-nav-title {
    @apply mb-0;
  }

  /* Active filter pills in sidebar */
  .sidebar-active-pills {
    @apply flex flex-wrap gap-1.5;
  }

  .sidebar-active-pills:empty {
    @apply hidden;
  }

  .active-pill {
    @apply inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium;
    background: var(--color-accent);
    color: var(--color-text-inverse);
  }

  /* Clear button */
  .filters-clear-btn {
    @apply flex shrink-0 cursor-pointer items-center gap-1 rounded-md px-2 py-1 text-xs font-medium;
    background: transparent;
    color: var(--color-text-muted);
    border: 1px solid var(--color-border);
    transition: all var(--transition-fast);
  }

  .filters-clear-btn:hover {
    color: var(--color-accent);
    border-color: var(--color-accent);
    background: var(--color-accent-subtle);
  }

  .filters-clear-btn.is-hidden {
    @apply hidden;
  }

  /* Filter groups */
  .filters-group + .filters-group {
    @apply mt-1;
  }

  .filters-group-label {
    @apply mb-2 block text-xs font-semibold tracking-wider uppercase;
    color: var(--color-text-muted);
  }

  .filters-group-tags {
    @apply flex flex-wrap gap-1.5;
  }

  /* Filter chips */
  .filter-chip {
    @apply cursor-pointer;
  }

  .filter-chip-input {
    @apply sr-only;
  }

  .filter-chip-pill {
    @apply inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs;
    background: var(--color-bg-elevated);
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
    transition: all var(--transition-fast);
  }

  .filter-chip-pill:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .filter-chip-count {
    @apply rounded px-1 py-0 text-xs;
    background: var(--color-bg-alt);
    color: var(--color-text-muted);
    font-size: 10px;
  }

  /* Selected state */
  .filter-chip-input:checked + .filter-chip-pill {
    background: var(--color-accent);
    color: var(--color-text-inverse);
    border-color: var(--color-accent);
  }

  .filter-chip-input:checked + .filter-chip-pill .filter-chip-count {
    background: var(--color-surface-glass);
    color: var(--color-text-inverse);
  }

  /* Empty state (count is 0) */
  .filter-chip--empty {
    opacity: 0.4;
    pointer-events: none;
  }

  .filter-chip--empty .filter-chip-pill {
    cursor: not-allowed;
  }

  /* ==========================================================================
     RESULTS SECTION
     ========================================================================== */

  .search-results-section {
    animation: fadeInUp var(--transition-slow) 250ms forwards;
    opacity: 0;
  }

  .results-header {
    @apply mb-6;
  }

  .results-count {
    @apply font-mono text-sm uppercase;
    letter-spacing: 0.08em;
    color: var(--color-text-muted);
  }

  .results-count.is-hidden {
    @apply hidden;
  }

  .search-results-list {
    @apply flex flex-col;
  }

  /* ==========================================================================
     RESULT CARD
     ========================================================================== */

  .search-result-card {
    @apply relative;
    border-bottom: 1px solid var(--color-border-subtle);
    animation: fadeInUp var(--transition-normal) forwards;
    opacity: 0;
  }

  .search-result-card:last-child {
    border-bottom: none;
  }

  .result-card-inner {
    @apply py-7;
    transition: all var(--transition-normal);
  }

  .search-result-card:hover .result-card-inner {
    padding-left: 1rem;
    margin-left: -1rem;
    margin-right: -1rem;
    padding-right: 1rem;
    background: linear-gradient(90deg, var(--color-accent-subtle), transparent 80%);
    border-radius: 8px;
  }

  .result-card-title {
    @apply mb-2 font-sans text-lg font-medium;
    line-height: 1.4;
  }

  .result-card-link {
    @apply no-underline;
    color: var(--color-text);
    transition: color var(--transition-fast);
  }

  .search-result-card:hover .result-card-link {
    color: var(--color-accent);
  }

  /* Clickable overlay */
  .result-card-link::after {
    content: "";
    @apply absolute top-0 left-0 h-full w-full;
  }

  .result-card-meta {
    @apply mb-2 flex flex-wrap items-center gap-x-1.5 gap-y-1 text-xs;
    color: var(--color-text-muted);
    position: relative;
    z-index: 1;
  }

  .result-meta-btn {
    background: none;
    border: none;
    padding: 0;
    font: inherit;
    color: var(--color-text-muted);
    cursor: pointer;
    transition: color var(--transition-fast);
  }

  .result-meta-btn:hover {
    color: var(--color-accent);
  }

  .result-meta-btn:focus {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
    border-radius: 2px;
  }

  .result-meta-sep {
    color: var(--color-border);
  }

  .result-meta-time {
    @apply ml-3 inline-flex items-center gap-1.5;
  }

  .result-meta-icon {
    @apply h-3.5 w-3.5;
  }

  .result-card-excerpt {
    @apply line-clamp-2 text-sm leading-relaxed;
    color: var(--color-text-muted);
  }

  /* ==========================================================================
     EMPTY STATE
     ========================================================================== */

  .search-empty-state {
    @apply py-20 text-center;
  }

  .search-empty-content {
    @apply flex flex-col items-center gap-4;
  }

  .search-empty-icon-wrapper {
    @apply flex h-20 w-20 items-center justify-center rounded-full;
    background: var(--color-accent-subtle);
    animation: scaleIn var(--transition-slow) forwards;
  }

  .search-empty-icon-wrapper--muted {
    background: var(--color-bg-alt);
  }

  .search-empty-icon {
    @apply h-10 w-10;
    color: var(--color-accent);
  }

  .search-empty-icon-wrapper--muted .search-empty-icon {
    color: var(--color-text-muted);
  }

  .search-empty-text {
    @apply text-lg font-medium;
    color: var(--color-text);
  }

  .search-empty-hint {
    @apply text-sm;
    color: var(--color-text-muted);
  }
</style>
