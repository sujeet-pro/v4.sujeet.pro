---
import Layout from "@/layout/layout.astro"
import { getSearchFacets } from "@/utils/search.utils"
import { SEARCH_SCHEMA } from "@/utils/search.types"
import { Icon } from "astro-icon/components"
import { getFilePath } from "@/utils/link.utils"

// Get facet options at build time (with counts, sorted by count)
const { categories, topics } = await getSearchFacets()

// Serialize data for client-side script
const searchSchemaJson = JSON.stringify(SEARCH_SCHEMA)
const searchIndexPath = getFilePath("search/index.json")
---

<Layout title="Search" description="Search for articles on Sujeet's blog" crumbs={null} pageType="default">
  <div class="search-page">
    <!-- Hero Section with Search -->
    <header class="search-hero">
      <h1 class="search-hero-title">Search</h1>
      <p class="search-hero-subtitle">Find articles across all categories and topics</p>

      <!-- Search Input -->
      <div class="search-box">
        <div class="search-box-inner">
          <Icon name="carbon:search" class="search-box-icon" />
          <input
            type="text"
            id="search-query"
            placeholder="What are you looking for?"
            class="search-box-input"
            autocomplete="off"
            autofocus
          />
          <kbd class="search-box-hint" id="search-hint">Enter</kbd>
        </div>
      </div>
    </header>

    <!-- Filters Section (Accordion) -->
    <section id="search-filters" class="filters-accordion" aria-label="Search filters">
      <div class="filters-header">
        <button
          type="button"
          class="filters-toggle"
          aria-expanded="false"
          aria-controls="filters-content"
          id="filters-trigger"
        >
          <Icon name="carbon:filter" class="filters-toggle-icon" />
          <span class="filters-toggle-label">Filters</span>
          <svg
            class="filters-toggle-chevron"
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>

        <!-- Active filter pills shown in header -->
        <div id="active-filters-display" class="filters-active-pills"></div>

        <button id="clear-filters" class="filters-clear-btn is-hidden" type="button">
          <Icon name="carbon:close" class="icon-sm" />
          <span>Clear all</span>
        </button>
      </div>

      <div id="filters-content" class="filters-body" hidden>
        <!-- Categories -->
        {
          categories.length > 0 && (
            <div class="filters-group">
              <span class="filters-group-label">Categories</span>
              <div class="filters-group-tags" id="category-filters">
                {categories.map((cat) => (
                  <label class="filter-chip" title={cat.title} data-filter-id={cat.id}>
                    <input type="checkbox" name="category" value={cat.id} class="filter-chip-input" />
                    <span class="filter-chip-pill">
                      {cat.name}
                      <span class="filter-chip-count" data-count-for={cat.id}>
                        {cat.count}
                      </span>
                    </span>
                  </label>
                ))}
              </div>
            </div>
          )
        }

        <!-- Topics -->
        {
          topics.length > 0 && (
            <div class="filters-group">
              <span class="filters-group-label">Topics</span>
              <div class="filters-group-tags" id="topic-filters">
                {topics.map((topic) => (
                  <label class="filter-chip" title={topic.title} data-filter-id={topic.id}>
                    <input type="checkbox" name="topic" value={topic.id} class="filter-chip-input" />
                    <span class="filter-chip-pill">
                      {topic.name}
                      <span class="filter-chip-count" data-count-for={topic.id}>
                        {topic.count}
                      </span>
                    </span>
                  </label>
                ))}
              </div>
            </div>
          )
        }
      </div>
    </section>

    <!-- Results Section -->
    <section class="search-results-section" aria-label="Search results">
      <div class="results-header">
        <p id="result-count" class="results-count is-hidden" aria-live="polite"></p>
      </div>

      <ul id="search-results" class="search-results-list">
        <li id="search-placeholder" class="search-empty-state">
          <div class="search-empty-content">
            <div class="search-empty-icon-wrapper">
              <Icon name="carbon:search-locate" class="search-empty-icon" />
            </div>
            <p class="search-empty-text">Loading articles...</p>
          </div>
        </li>
      </ul>
    </section>
  </div>

  <!-- Pass data to client via JSON script tags -->
  <script is:inline id="search-schema-data" type="application/json" set:html={searchSchemaJson} />
  <script is:inline id="search-index-path" type="application/json" set:html={JSON.stringify(searchIndexPath)} />
</Layout>

<script>
  import { create, load, search } from "@orama/orama"

  // Load shared constants from server-rendered JSON
  const searchSchema = JSON.parse(document.getElementById("search-schema-data")?.textContent ?? "{}")

  interface SearchParams {
    q: string
    categories: string[]
    topics: string[]
  }

  let db: Awaited<ReturnType<typeof create<typeof searchSchema>>> | null = null

  // Use DOM marker to track initialization (survives script re-execution)
  const INIT_MARKER = "data-search-initialized"

  // Get search index path from server-rendered data
  const searchIndexPath = JSON.parse(
    document.getElementById("search-index-path")?.textContent ?? '"/search/index.json"',
  )

  // Load search index
  async function loadIndex() {
    if (db) return
    try {
      const response = await fetch(searchIndexPath)
      const data = await response.json()
      db = create({ schema: searchSchema })
      load(db, data)
    } catch (e) {
      console.error("Failed to load search index:", e)
    }
  }

  // Parse URL params
  function getUrlParams(): SearchParams {
    const params = new URLSearchParams(window.location.search)
    return {
      q: params.get("q") || "",
      categories: params.get("categories")?.split(",").filter(Boolean) || [],
      topics: params.get("topics")?.split(",").filter(Boolean) || [],
    }
  }

  // Update URL and trigger search via replaceState
  function updateUrl(params: SearchParams) {
    const url = new URL(window.location.href)

    if (params.q) url.searchParams.set("q", params.q)
    else url.searchParams.delete("q")

    if (params.categories.length) url.searchParams.set("categories", params.categories.join(","))
    else url.searchParams.delete("categories")

    if (params.topics.length) url.searchParams.set("topics", params.topics.join(","))
    else url.searchParams.delete("topics")

    // Use replaceState to update URL without adding to history
    window.history.replaceState({}, "", url.toString())
    // Trigger search with new params
    handleUrlChange()
  }

  // Toggle a value in an array (add if not present, remove if present)
  function toggleArrayValue(arr: string[], value: string): string[] {
    const index = arr.indexOf(value)
    if (index === -1) {
      return [...arr, value]
    } else {
      return arr.filter((v) => v !== value)
    }
  }

  // Check if any filters (categories/topics) are active
  function hasFiltersActive(params: SearchParams) {
    return params.categories.length > 0 || params.topics.length > 0
  }

  // Sync UI with current URL params
  function syncUIWithParams(params: SearchParams) {
    const queryInput = document.getElementById("search-query") as HTMLInputElement
    const hintEl = document.getElementById("search-hint") as HTMLElement
    const clearBtn = document.getElementById("clear-filters") as HTMLButtonElement
    const activeFiltersDisplay = document.getElementById("active-filters-display") as HTMLElement
    const filtersTrigger = document.getElementById("filters-trigger") as HTMLButtonElement
    const filtersContent = document.getElementById("filters-content") as HTMLElement

    if (!queryInput) return

    queryInput.value = params.q

    // Sync category checkboxes
    document.querySelectorAll<HTMLInputElement>('#search-filters input[name="category"]').forEach((cb) => {
      cb.checked = params.categories.includes(cb.value)
    })

    // Sync topic checkboxes
    document.querySelectorAll<HTMLInputElement>('#search-filters input[name="topic"]').forEach((cb) => {
      cb.checked = params.topics.includes(cb.value)
    })

    // Show/hide hint based on query
    if (params.q) {
      hintEl?.classList.add("is-hidden")
    } else {
      hintEl?.classList.remove("is-hidden")
    }

    // Update active filters display (pills in header) and clear button
    if (hasFiltersActive(params)) {
      clearBtn?.classList.remove("is-hidden")

      // Build active filter pills HTML
      if (activeFiltersDisplay) {
        const pills: string[] = []

        // Get category names (just the name, not the count)
        params.categories.forEach((catId) => {
          const label = document.querySelector(`#category-filters [data-filter-id="${catId}"]`)
          const nameEl = label?.querySelector(".filter-chip-pill")
          // Get just the text before the count span
          const name = nameEl?.childNodes[0]?.textContent?.trim()
          if (name) {
            pills.push(`<span class="active-pill" data-type="category" data-value="${catId}">${name}</span>`)
          }
        })

        // Get topic names (just the name, not the count)
        params.topics.forEach((topicId) => {
          const label = document.querySelector(`#topic-filters [data-filter-id="${topicId}"]`)
          const nameEl = label?.querySelector(".filter-chip-pill")
          // Get just the text before the count span
          const name = nameEl?.childNodes[0]?.textContent?.trim()
          if (name) {
            pills.push(`<span class="active-pill" data-type="topic" data-value="${topicId}">${name}</span>`)
          }
        })

        activeFiltersDisplay.innerHTML = pills.join("")
      }
    } else {
      clearBtn?.classList.add("is-hidden")
      if (activeFiltersDisplay) {
        activeFiltersDisplay.innerHTML = ""
      }
    }
  }

  // Render a single result item HTML
  function renderResultItem(hit: any, index: number): string {
    const doc = hit.document
    const href = doc.href || ""
    const title = doc.title || "Untitled"
    const description = doc.description || ""
    const categoryId = doc.category || ""
    const categoryName = doc.categoryName || ""
    const topicId = doc.topic || ""
    const topicName = doc.topicName || ""
    const minutesRead = doc.minutesRead || ""

    // Stagger animation delay
    const delay = Math.min(index * 50, 400)

    return `
      <li class="search-result-card" style="animation-delay: ${delay}ms">
        <article class="result-card-inner">
          <h3 class="result-card-title">
            <a href="${href}" class="result-card-link">${title}</a>
          </h3>
          <div class="result-card-meta">
            ${categoryName ? `<button type="button" class="result-meta-btn" data-filter-type="category" data-filter-value="${categoryId}">${categoryName}</button>` : ""}
            ${topicName ? `<span class="result-meta-sep">/</span><button type="button" class="result-meta-btn" data-filter-type="topic" data-filter-value="${topicId}">${topicName}</button>` : ""}
            ${
              minutesRead
                ? `<span class="result-meta-time">
                <svg xmlns="http://www.w3.org/2000/svg" class="result-meta-icon" viewBox="0 0 32 32"><path fill="currentColor" d="M16 30a14 14 0 1 1 14-14a14 14 0 0 1-14 14m0-26a12 12 0 1 0 12 12A12 12 0 0 0 16 4"/><path fill="currentColor" d="M20.59 22L15 16.41V7h2v8.58l5 5.01z"/></svg>
                <span>${minutesRead}</span>
              </span>`
                : ""
            }
          </div>
          <p class="result-card-excerpt">${description}</p>
        </article>
      </li>
    `
  }

  // Calculate facet counts from a set of hits
  function calculateFacetCounts(hits: any[]): { categories: Map<string, number>; topics: Map<string, number> } {
    const categories = new Map<string, number>()
    const topics = new Map<string, number>()

    for (const hit of hits) {
      const category = hit.document.category || ""
      const topic = hit.document.topic || ""

      if (category) {
        categories.set(category, (categories.get(category) || 0) + 1)
      }
      if (topic) {
        topics.set(topic, (topics.get(topic) || 0) + 1)
      }
    }

    return { categories, topics }
  }

  // Update facet counts
  function updateFacetCounts(counts: { categories: Map<string, number>; topics: Map<string, number> }) {
    // Update category counts
    document.querySelectorAll("#category-filters [data-count-for]").forEach((el) => {
      const id = el.getAttribute("data-count-for")
      if (id) {
        const count = counts.categories.get(id) || 0
        el.textContent = `${count}`
        // Dim the label if count is 0
        const label = el.closest(".filter-chip")
        if (label) {
          label.classList.toggle("filter-chip--empty", count === 0)
        }
      }
    })

    // Update topic counts
    document.querySelectorAll("#topic-filters [data-count-for]").forEach((el) => {
      const id = el.getAttribute("data-count-for")
      if (id) {
        const count = counts.topics.get(id) || 0
        el.textContent = `${count}`
        // Dim the label if count is 0
        const label = el.closest(".filter-chip")
        if (label) {
          label.classList.toggle("filter-chip--empty", count === 0)
        }
      }
    })
  }

  // Execute search
  async function executeSearch(params: SearchParams) {
    await loadIndex()
    if (!db) {
      console.error("Search index not loaded")
      return
    }

    const resultsEl = document.getElementById("search-results") as HTMLUListElement
    const countEl = document.getElementById("result-count") as HTMLParagraphElement

    if (!resultsEl) return

    // Step 1: Execute search query (empty term returns all documents)
    const results = await search(db, {
      term: params.q || "",
      limit: 1000,
    })

    // Step 2: Get query-filtered results (before category/topic filters)
    const queryFilteredHits = results.hits as any[]

    // Step 3: Apply category/topic filters on top of query results
    let finalHits = queryFilteredHits

    // Category filter (OR logic - match any selected category)
    if (params.categories.length > 0) {
      finalHits = finalHits.filter((hit) => {
        const category = hit.document.category || ""
        return params.categories.includes(category)
      })
    }

    // Topic filter (OR logic - match any selected topic)
    if (params.topics.length > 0) {
      finalHits = finalHits.filter((hit) => {
        const topic = hit.document.topic || ""
        return params.topics.includes(topic)
      })
    }

    // Step 4: Calculate facet counts from final results (current displayed set)
    const facetCounts = calculateFacetCounts(finalHits)
    updateFacetCounts(facetCounts)

    // Handle no results
    if (finalHits.length === 0) {
      resultsEl.innerHTML = `
        <li class="search-empty-state">
          <div class="search-empty-content">
            <div class="search-empty-icon-wrapper search-empty-icon-wrapper--muted">
              <svg xmlns="http://www.w3.org/2000/svg" class="search-empty-icon" viewBox="0 0 32 32"><path fill="currentColor" d="M16 2a14 14 0 1 0 14 14A14 14 0 0 0 16 2m0 26a12 12 0 1 1 12-12a12 12 0 0 1-12 12"/><path fill="currentColor" d="M11.5 11a2.5 2.5 0 1 0 2.5 2.5a2.5 2.5 0 0 0-2.5-2.5m9 0a2.5 2.5 0 1 0 2.5 2.5a2.5 2.5 0 0 0-2.5-2.5M16 19a8 8 0 0 0-6.85 3.89l1.71 1a6 6 0 0 1 10.28 0l1.71-1A8 8 0 0 0 16 19"/></svg>
            </div>
            <p class="search-empty-text">No matching articles found</p>
            <p class="search-empty-hint">Try different search terms or filters</p>
          </div>
        </li>
      `
      countEl?.classList.add("is-hidden")
      return
    }

    // Show result count
    if (countEl) {
      const countText = finalHits.length === 1 ? "1 article found" : `${finalHits.length} articles found`
      countEl.textContent = countText
      countEl.classList.remove("is-hidden")
    }

    // Render all results
    resultsEl.innerHTML = finalHits.map((hit, index) => renderResultItem(hit, index)).join("")
  }

  // Handle URL change (the single source of truth for search)
  async function handleUrlChange() {
    const params = getUrlParams()
    syncUIWithParams(params)
    await executeSearch(params)
  }

  // Main initialization function
  async function initSearchPage() {
    // Guard: only run on search page
    const queryInput = document.getElementById("search-query") as HTMLInputElement
    if (!queryInput) return

    // Guard: prevent double initialization using DOM marker
    if (queryInput.hasAttribute(INIT_MARKER)) return
    queryInput.setAttribute(INIT_MARKER, "true")

    const clearBtn = document.getElementById("clear-filters") as HTMLButtonElement
    const resultsEl = document.getElementById("search-results")
    const filtersEl = document.getElementById("search-filters")
    const filtersTrigger = document.getElementById("filters-trigger") as HTMLButtonElement
    const filtersContent = document.getElementById("filters-content") as HTMLElement

    // Listen for URL changes (back/forward navigation)
    window.addEventListener("popstate", handleUrlChange)

    // Accordion toggle for filters
    filtersTrigger?.addEventListener("click", (e) => {
      // Don't toggle if clicking the clear button
      if ((e.target as HTMLElement).closest(".filters-clear")) {
        return
      }
      const expanded = filtersTrigger.getAttribute("aria-expanded") === "true"
      filtersTrigger.setAttribute("aria-expanded", String(!expanded))
      if (filtersContent) {
        filtersContent.hidden = expanded
      }
    })

    // Handle filter button clicks in search results (event delegation)
    resultsEl?.addEventListener("click", (e: Event) => {
      const target = e.target as HTMLElement
      if (!target) return

      const filterBtn = target.closest(".result-meta-btn") as HTMLButtonElement | null
      if (!filterBtn) return

      e.preventDefault()
      e.stopPropagation()

      const filterType = filterBtn.getAttribute("data-filter-type")
      const filterValue = filterBtn.getAttribute("data-filter-value")
      if (!filterType || !filterValue) return

      const params = getUrlParams()

      if (filterType === "category") {
        params.categories = toggleArrayValue(params.categories, filterValue)
      } else if (filterType === "topic") {
        params.topics = toggleArrayValue(params.topics, filterValue)
      }

      updateUrl(params)
    })

    // Handle filter changes (event delegation)
    filtersEl?.addEventListener("change", (e: Event) => {
      const target = e.target as HTMLInputElement
      if (!target || target.type !== "checkbox") return

      const filterName = target.name
      const filterValue = target.value
      const params = getUrlParams()

      if (filterName === "category") {
        params.categories = toggleArrayValue(params.categories, filterValue)
      } else if (filterName === "topic") {
        params.topics = toggleArrayValue(params.topics, filterValue)
      }

      updateUrl(params)
    })

    // Query input: update URL on Enter
    queryInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const params = getUrlParams()
        params.q = queryInput.value.trim()
        updateUrl(params)
      }
    })

    // Clear all filters (keep query): reset filters only
    clearBtn?.addEventListener("click", () => {
      const params = getUrlParams()
      updateUrl({ q: params.q, categories: [], topics: [] })
    })

    // Focus input on load
    queryInput.focus()

    // Initial sync and search based on current URL
    await handleUrlChange()
  }

  // Initialize on DOMContentLoaded
  document.addEventListener("DOMContentLoaded", initSearchPage)

  // Re-initialize on Astro page navigation (for SPA)
  document.addEventListener("astro:page-load", initSearchPage)
</script>

<style is:global>
  @reference "tailwindcss";

  /* ==========================================================================
     SEARCH PAGE - "Serene Scholar" Design System
     ========================================================================== */

  .search-page {
    @apply py-6;
  }

  /* ==========================================================================
     HERO SECTION
     ========================================================================== */

  .search-hero {
    @apply mb-12 text-center;
    animation: fadeInUp var(--transition-slow) forwards;
  }

  .search-hero-title {
    @apply mb-3 font-sans font-normal;
    font-size: clamp(36px, 6vw, 52px);
    line-height: 1.1;
    letter-spacing: -0.03em;
    color: var(--color-text);
  }

  .search-hero-subtitle {
    @apply mb-10;
    font-size: 18px;
    line-height: 1.6;
    color: var(--color-text-muted);
    animation: fadeInUp var(--transition-slow) 100ms forwards;
    opacity: 0;
  }

  /* ==========================================================================
     SEARCH BOX
     ========================================================================== */

  .search-box {
    @apply mx-auto;
    max-width: 600px;
    animation: fadeInUp var(--transition-slow) 150ms forwards;
    opacity: 0;
  }

  .search-box-inner {
    @apply relative flex items-center;
  }

  .search-box-icon {
    @apply absolute left-5 h-5 w-5;
    color: var(--color-text-muted);
    pointer-events: none;
    transition: color var(--transition-fast);
  }

  .search-box-input {
    @apply w-full rounded-2xl border-2 py-4 pr-20 pl-14 text-lg;
    border-color: var(--color-border);
    background: var(--color-bg-elevated);
    color: var(--color-text);
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-fast);
  }

  .search-box-input:focus {
    @apply outline-none;
    border-color: var(--color-accent);
    box-shadow: var(--shadow-md), 0 0 0 4px var(--color-accent-subtle);
  }

  .search-box-input:focus ~ .search-box-icon {
    color: var(--color-accent);
  }

  .search-box-input::placeholder {
    color: var(--color-text-muted);
    font-weight: 400;
  }

  .search-box-hint {
    @apply absolute right-4 rounded-lg px-2.5 py-1.5 font-mono text-xs;
    background: var(--color-bg-alt);
    color: var(--color-text-muted);
    border: 1px solid var(--color-border-subtle);
    pointer-events: none;
    transition: opacity var(--transition-fast);
  }

  .search-box-hint.is-hidden {
    opacity: 0;
  }

  /* ==========================================================================
     FILTERS ACCORDION
     ========================================================================== */

  .filters-accordion {
    @apply mb-10 rounded-xl border;
    border-color: var(--color-border-subtle);
    background: var(--color-bg-alt);
    animation: fadeInUp var(--transition-slow) 200ms forwards;
    opacity: 0;
  }

  /* Header row - contains toggle, active pills, and clear button */
  .filters-header {
    @apply flex items-center gap-3 px-4 py-3;
  }

  /* Toggle button */
  .filters-toggle {
    @apply flex cursor-pointer items-center gap-2 rounded-lg border-0 bg-transparent px-2 py-1.5;
    transition: background-color var(--transition-fast);
  }

  .filters-toggle:hover {
    background: var(--color-accent-subtle);
  }

  .filters-toggle-icon {
    @apply h-4 w-4 shrink-0;
    color: var(--color-text-muted);
    transition: color var(--transition-fast);
  }

  .filters-toggle:hover .filters-toggle-icon,
  .filters-toggle[aria-expanded="true"] .filters-toggle-icon {
    color: var(--color-accent);
  }

  .filters-toggle-label {
    @apply font-sans text-sm font-medium;
    color: var(--color-text);
  }

  .filters-toggle-chevron {
    @apply shrink-0;
    color: var(--color-text-muted);
    transition: transform var(--transition-normal), color var(--transition-fast);
  }

  .filters-toggle:hover .filters-toggle-chevron {
    color: var(--color-text);
  }

  .filters-toggle[aria-expanded="true"] .filters-toggle-chevron {
    transform: rotate(180deg);
    color: var(--color-accent);
  }

  /* Active filter pills in header */
  .filters-active-pills {
    @apply flex flex-1 flex-wrap items-center gap-2;
  }

  .active-pill {
    @apply inline-flex items-center rounded-full px-3 py-1 text-xs font-medium;
    background: var(--color-accent);
    color: white;
  }

  /* Clear button */
  .filters-clear-btn {
    @apply ml-auto flex shrink-0 cursor-pointer items-center gap-1.5 rounded-lg px-3 py-1.5 text-xs font-medium;
    background: transparent;
    color: var(--color-text-muted);
    border: 1px solid var(--color-border);
    transition: all var(--transition-fast);
  }

  .filters-clear-btn:hover {
    color: var(--color-accent);
    border-color: var(--color-accent);
    background: var(--color-accent-subtle);
  }

  .filters-clear-btn.is-hidden {
    @apply hidden;
  }

  /* Filter body (expandable content) */
  .filters-body {
    @apply px-4 pb-4;
    border-top: 1px solid var(--color-border-subtle);
  }

  .filters-body[hidden] {
    display: none;
  }

  .filters-group {
    @apply pt-4;
  }

  .filters-group + .filters-group {
    @apply mt-4;
  }

  .filters-group-label {
    @apply mb-3 block text-xs font-semibold uppercase tracking-wider;
    color: var(--color-text-muted);
  }

  .filters-group-tags {
    @apply flex flex-wrap gap-2;
  }

  /* Filter chips */
  .filter-chip {
    @apply cursor-pointer;
  }

  .filter-chip-input {
    @apply sr-only;
  }

  .filter-chip-pill {
    @apply inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-sm;
    background: var(--color-bg-elevated);
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
    transition: all var(--transition-fast);
  }

  .filter-chip-pill:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .filter-chip-count {
    @apply rounded px-1.5 py-0.5 text-xs;
    background: var(--color-bg-alt);
    color: var(--color-text-muted);
  }

  /* Selected state */
  .filter-chip-input:checked + .filter-chip-pill {
    background: var(--color-accent);
    color: white;
    border-color: var(--color-accent);
  }

  .filter-chip-input:checked + .filter-chip-pill .filter-chip-count {
    background: rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.9);
  }

  /* Empty state (count is 0) */
  .filter-chip--empty {
    opacity: 0.4;
    pointer-events: none;
  }

  .filter-chip--empty .filter-chip-pill {
    cursor: not-allowed;
  }

  /* ==========================================================================
     FILTER TAG PILL
     ========================================================================== */

  .filter-tag {
    @apply cursor-pointer;
  }

  .filter-tag-input {
    @apply sr-only;
  }

  .filter-tag-pill {
    @apply inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-medium;
    background: var(--color-bg-elevated);
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
    transition: all var(--transition-fast);
  }

  .filter-tag-pill:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .filter-tag-count {
    @apply rounded-full px-2 py-0.5 text-xs;
    background: var(--color-bg-alt);
    color: var(--color-text-muted);
    min-width: 1.5rem;
    text-align: center;
    transition: all var(--transition-fast);
  }

  /* Active state */
  .filter-tag input:checked + .filter-tag-pill {
    background: var(--color-accent);
    color: white;
    border-color: var(--color-accent);
  }

  .filter-tag input:checked + .filter-tag-pill .filter-tag-count {
    background: rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.9);
  }

  /* Empty state (count is 0) */
  .filter-tag--empty {
    opacity: 0.4;
    pointer-events: none;
  }

  .filter-tag--empty .filter-tag-pill {
    cursor: not-allowed;
  }

  /* ==========================================================================
     RESULTS SECTION
     ========================================================================== */

  .search-results-section {
    animation: fadeInUp var(--transition-slow) 250ms forwards;
    opacity: 0;
  }

  .results-header {
    @apply mb-6;
  }

  .results-count {
    @apply font-mono text-sm uppercase;
    letter-spacing: 0.08em;
    color: var(--color-text-muted);
  }

  .results-count.is-hidden {
    @apply hidden;
  }

  .search-results-list {
    @apply flex flex-col;
  }

  /* ==========================================================================
     RESULT CARD
     ========================================================================== */

  .search-result-card {
    @apply relative;
    border-bottom: 1px solid var(--color-border-subtle);
    animation: fadeInUp var(--transition-normal) forwards;
    opacity: 0;
  }

  .search-result-card:last-child {
    border-bottom: none;
  }

  .result-card-inner {
    @apply py-7;
    transition: all var(--transition-normal);
  }

  .search-result-card:hover .result-card-inner {
    padding-left: 1rem;
    margin-left: -1rem;
    margin-right: -1rem;
    padding-right: 1rem;
    background: linear-gradient(90deg, var(--color-accent-subtle), transparent 80%);
    border-radius: 8px;
  }

  .result-card-title {
    @apply mb-2 font-sans text-lg font-medium;
    line-height: 1.4;
  }

  .result-card-link {
    @apply no-underline;
    color: var(--color-text);
    transition: color var(--transition-fast);
  }

  .search-result-card:hover .result-card-link {
    color: var(--color-accent);
  }

  /* Clickable overlay */
  .result-card-link::after {
    content: "";
    @apply absolute top-0 left-0 h-full w-full;
  }

  .result-card-meta {
    @apply mb-2 flex flex-wrap items-center gap-x-1.5 gap-y-1 text-xs;
    color: var(--color-text-muted);
    position: relative;
    z-index: 1;
  }

  .result-meta-btn {
    background: none;
    border: none;
    padding: 0;
    font: inherit;
    color: var(--color-text-muted);
    cursor: pointer;
    transition: color var(--transition-fast);
  }

  .result-meta-btn:hover {
    color: var(--color-accent);
  }

  .result-meta-btn:focus {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
    border-radius: 2px;
  }

  .result-meta-sep {
    color: var(--color-border);
  }

  .result-meta-time {
    @apply ml-3 inline-flex items-center gap-1.5;
  }

  .result-meta-icon {
    @apply h-3.5 w-3.5;
  }

  .result-card-excerpt {
    @apply line-clamp-2 text-sm leading-relaxed;
    color: var(--color-text-muted);
  }

  /* ==========================================================================
     EMPTY STATE
     ========================================================================== */

  .search-empty-state {
    @apply py-20 text-center;
  }

  .search-empty-content {
    @apply flex flex-col items-center gap-4;
  }

  .search-empty-icon-wrapper {
    @apply flex h-20 w-20 items-center justify-center rounded-full;
    background: var(--color-accent-subtle);
    animation: scaleIn var(--transition-slow) forwards;
  }

  .search-empty-icon-wrapper--muted {
    background: var(--color-bg-alt);
  }

  .search-empty-icon {
    @apply h-10 w-10;
    color: var(--color-accent);
  }

  .search-empty-icon-wrapper--muted .search-empty-icon {
    color: var(--color-text-muted);
  }

  .search-empty-text {
    @apply text-lg font-medium;
    color: var(--color-text);
  }

  .search-empty-hint {
    @apply text-sm;
    color: var(--color-text-muted);
  }
</style>
