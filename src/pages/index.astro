---
import { getEntry } from "astro:content"
import Layout from "@/layout/layout.astro"
import Link from "@/components/ui/link.astro"
import { getCategoryHierarchy, getFeaturedArticlesCards } from "@/utils/content"
import { getSocialLinks } from "@/utils/site.utils"
import { formatCount } from "@/utils/format.utils"
import sujeetImage from "@/assets/sujeet.jpg"

const homeEntry = await getEntry("home", "home")
if (!homeEntry) throw new Error("Home page content not found.")
const { pageTitle, pageDescription, profile } = homeEntry.data

const social = await getSocialLinks()
const categories = await getCategoryHierarchy()
const featuredArticles = await getFeaturedArticlesCards()
const totalArticles = categories.reduce((sum, cat) => sum + cat.articleCount, 0)
const totalTopics = categories.reduce((sum, cat) => sum + cat.topics.length, 0)
---

<Layout title={pageTitle} description={pageDescription} crumbs={null} pageType="default">
  <div class="fn-page">
    <!-- Header (Style 4 + profile image) -->
    <header class="fn-header">
      <div class="fn-header-identity">
        <img src={sujeetImage.src} alt={profile.imageAlt} class="fn-avatar" />
        <div>
          <h1 class="fn-name">{profile.name}</h1>
          <p class="fn-subtitle">{profile.title}</p>
        </div>
      </div>
      <p class="fn-desc">
        Deep-dive technical articles on system design, browser internals, frontend architecture, and everything in
        between.
      </p>
      <nav class="fn-nav">
        <Link href={social.linkedin.url} class="fn-nav-item">LinkedIn</Link>
        <Link href="/cv" class="fn-nav-item" isVanity={true}>CV</Link>
        <Link href="/random" class="fn-nav-item">I'm Feeling Lucky</Link>
      </nav>
    </header>

    <hr class="fn-rule" />

    <!-- Knowledge Hub (Style 2 header + Style 4 cards + Style 1 topics) -->
    <section class="fn-section">
      <div class="fn-hub-head">
        <h2 class="fn-hub-title">Knowledge Hub</h2>
        <span class="fn-hub-stats">
          {totalArticles}+ articles · {categories.length} categories · {totalTopics} topics
        </span>
      </div>
      <p class="fn-hub-desc">Deep-dive articles for engineers who want to understand how things actually work.</p>

      <div class="fn-grid">
        {
          categories.map((category, index) => (
            <a href={category.href} class="fn-card" style={`animation-delay: ${index * 70}ms`}>
              <div class="fn-card-head">
                <h3 class="fn-card-name">{category.name}</h3>
                <span class="fn-card-counts">
                  {category.topics.length} {category.topics.length === 1 ? "topic" : "topics"} ·{" "}
                  {formatCount(category.articleCount, "article")}
                </span>
              </div>
              <p class="fn-card-topics">
                {category.topics.map((topic, i) => (
                  <>
                    {topic.name}
                    {i < category.topics.length - 1 && <span class="fn-card-topic-sep"> · </span>}
                  </>
                ))}
              </p>
              <span class="fn-card-arrow">&rarr;</span>
            </a>
          ))
        }
      </div>
    </section>

    <hr class="fn-rule" />

    <!-- Featured Articles (Style 1) -->
    {
      featuredArticles.length > 0 && (
        <section class="fn-section">
          <div class="fn-fa-label">
            <span class="fn-label-text">Featured Articles</span>
          </div>
          <div class="fn-fa-header">
            <p class="fn-fa-subtitle">Hand-picked reads</p>
            <Link href="/articles" class="fn-fa-more">
              All articles &rarr;
            </Link>
          </div>

          <ul class="fn-articles">
            {featuredArticles.map((article, index) => (
              <li class="fn-article" style={`animation-delay: ${index * 80}ms`}>
                <h3 class="fn-article-title">
                  <Link href={article.href} class="fn-article-link">
                    {article.title}
                  </Link>
                </h3>
                <span class="fn-article-meta">
                  {article.category.name} · {article.topic.name}
                  {article.minutesRead && <> · {article.minutesRead}</>}
                </span>
              </li>
            ))}
          </ul>
        </section>
      )
    }
  </div>
</Layout>

<style is:global>
  @reference "tailwindcss";

  .fn-page {
    @apply mx-auto;
    max-width: var(--content-max-width);
    padding-top: 3rem;
    padding-bottom: 4rem;
  }

  /* ══════════════════════════════════════════════════════════════════════════
     HEADER (from Style 4)
     ══════════════════════════════════════════════════════════════════════════ */

  .fn-header {
    @apply mb-0;
    animation: fadeInUp var(--transition-slow) forwards;
  }

  .fn-header-identity {
    @apply inline-flex flex-col items-center gap-3;
  }

  @media (min-width: 480px) {
    .fn-header-identity {
      @apply flex-row items-center gap-3;
    }
  }

  .fn-avatar {
    @apply shrink-0 rounded-full object-cover;
    width: 56px;
    height: 56px;
    border: 2px solid var(--color-border);
  }

  /* Center text on mobile when stacked vertically */
  @media (max-width: 479px) {
    .fn-header {
      @apply text-center;
    }

    .fn-nav {
      @apply justify-center;
    }
  }

  .fn-name {
    @apply font-sans font-normal;
    font-size: clamp(30px, 5vw, 42px);
    line-height: 1.1;
    letter-spacing: -0.03em;
    color: var(--color-text);
  }

  .fn-subtitle {
    @apply mt-0.5;
    font-size: 16px;
    color: var(--color-text-muted);
  }

  .fn-desc {
    @apply mt-5 text-base leading-relaxed;
    color: var(--color-text-secondary);
    max-width: 55ch;
  }

  .fn-nav {
    @apply mt-6 flex flex-wrap items-center gap-2;
  }

  .fn-nav-item {
    font-family: var(--font-mono);
    font-size: 12px;
    letter-spacing: 0.03em;
    color: var(--color-text-muted);
    text-decoration: none;
    padding: 6px 14px;
    border: 1px solid var(--color-border);
    border-radius: 3px;
    transition: all var(--transition-fast);
  }

  .fn-nav-item:hover {
    color: var(--color-text);
    border-color: var(--color-text);
  }

  /* ══════════════════════════════════════════════════════════════════════════
     SHARED
     ══════════════════════════════════════════════════════════════════════════ */

  .fn-rule {
    @apply my-10 border-0;
    height: 1px;
    background: var(--color-border);
  }

  .fn-section {
    animation: fadeInUp var(--transition-slow) 150ms forwards;
    opacity: 0;
  }

  /* ══════════════════════════════════════════════════════════════════════════
     KNOWLEDGE HUB HEADER (from Style 2)
     ══════════════════════════════════════════════════════════════════════════ */

  .fn-hub-head {
    @apply mb-2 flex flex-wrap items-baseline justify-between gap-4;
  }

  .fn-hub-title {
    font-family: var(--font-mono);
    font-size: 11px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--color-text-muted);
    font-weight: 400;
  }

  .fn-hub-stats {
    font-family: var(--font-mono);
    font-size: 11px;
    letter-spacing: 0.06em;
    color: var(--color-text-muted);
  }

  .fn-hub-desc {
    @apply mb-8 text-base;
    color: var(--color-text-secondary);
    max-width: 55ch;
  }

  /* ══════════════════════════════════════════════════════════════════════════
     CATEGORY CARDS (Style 4 shell + Style 1 topic listing)
     ══════════════════════════════════════════════════════════════════════════ */

  .fn-grid {
    @apply grid gap-4;
    grid-template-columns: 1fr;
  }

  @media (min-width: 640px) {
    .fn-grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  .fn-card {
    @apply relative block p-5;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    text-decoration: none;
    transition: all var(--transition-fast);
    animation: fadeInUp var(--transition-slow) forwards;
    opacity: 0;
  }

  .fn-card:hover {
    border-color: var(--color-text);
  }

  .fn-card:hover .fn-card-arrow {
    opacity: 1;
    transform: translateX(0);
  }

  .fn-card-head {
    @apply mb-3;
  }

  .fn-card-name {
    @apply font-sans text-lg font-medium;
    color: var(--color-text);
    line-height: 1.3;
  }

  .fn-card-counts {
    @apply mt-1 block;
    font-family: var(--font-mono);
    font-size: 11px;
    letter-spacing: 0.06em;
    color: var(--color-text-muted);
  }

  .fn-card-topics {
    @apply text-sm leading-relaxed;
    color: var(--color-text-secondary);
  }

  .fn-card-topic-sep {
    color: var(--color-text-muted);
  }

  .fn-card-arrow {
    @apply absolute top-5 right-4;
    font-family: var(--font-mono);
    font-size: 16px;
    color: var(--color-text);
    opacity: 0;
    transform: translateX(-4px);
    transition: all var(--transition-fast);
  }

  /* ══════════════════════════════════════════════════════════════════════════
     FEATURED ARTICLES (from Style 1)
     ══════════════════════════════════════════════════════════════════════════ */

  .fn-fa-label {
    @apply mb-4;
  }

  .fn-label-text {
    font-family: var(--font-mono);
    font-size: 11px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--color-text-muted);
  }

  .fn-fa-header {
    @apply mb-8 flex flex-wrap items-baseline justify-between gap-4;
  }

  .fn-fa-subtitle {
    @apply text-sm;
    color: var(--color-text-muted);
  }

  .fn-fa-more {
    font-family: var(--font-mono);
    font-size: 12px;
    letter-spacing: 0.04em;
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .fn-fa-more:hover {
    color: var(--color-text);
  }

  .fn-articles {
    @apply list-none p-0;
  }

  .fn-article {
    @apply py-5;
    border-bottom: 1px solid var(--color-border);
    animation: fadeInUp var(--transition-slow) forwards;
    opacity: 0;
  }

  .fn-article:first-child {
    border-top: 1px solid var(--color-border);
  }

  .fn-article-title {
    @apply mb-1 font-sans text-lg font-normal;
    line-height: 1.4;
  }

  .fn-article-link {
    color: var(--color-text);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .fn-article-link:hover {
    color: var(--color-text-muted);
  }

  .fn-article-meta {
    font-family: var(--font-mono);
    font-size: 11px;
    letter-spacing: 0.06em;
    color: var(--color-text-muted);
  }
</style>
