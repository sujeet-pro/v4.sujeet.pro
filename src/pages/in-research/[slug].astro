---
import { Icon } from "astro-icon/components"
import ArticleTags from "@/components/article-tags.astro"
import CategoryNav from "@/components/category-nav.astro"
import TOC from "@/components/toc.astro"
import Frontmatter from "@/components/frontmatter.astro"
import Layout from "@/layout/layout.astro"
import ReadingProgress from "@/components/reading-progress.astro"
import { getInResearchIncludingDrafts } from "@/utils/content-inresearch.utils"
import type { InResearchContent } from "@/utils/content.type"

// Generate static paths for all in-research items (including drafts)
export async function getStaticPaths() {
  const items = await getInResearchIncludingDrafts()

  return items.map((item) => {
    // Get all articles for the left sidebar navigation
    const allArticles = items.map((i) => ({
      id: i.id,
      title: i.title,
      href: i.href,
    }))

    return {
      params: {
        slug: item.pageSlug,
      },
      props: {
        item,
        allArticles,
      },
    }
  })
}

interface Props {
  item: InResearchContent
  allArticles: { id: string; title: string; href: string }[]
}

const { item, allArticles } = Astro.props
const { description, lastUpdatedOn, title, minutesRead, tags, Content, isDraft } = item

const crumbs = [{ name: "In Research", href: "/in-research" }]
---

<Layout {title} {description} {crumbs} pageType="article" noIndex={true} layout="3col">
  <!-- Left sidebar: All in-research articles navigation (desktop only) -->
  <CategoryNav
    slot="sidebar-left"
    categoryName="In Research"
    articles={allArticles}
    currentArticleId={item.id}
  />

  <!-- TOC in right sidebar -->
  <TOC slot="sidebar-right" />

  <!-- Content top (above main) -->
  <ReadingProgress slot="content-top" />

  <!-- Navigation inline (mobile/tablet only) -->
  <details slot="content-top" class="category-nav-inline" id="category-nav-inline">
    <summary class="category-nav-inline-summary">
      <span class="category-nav-inline-title">
        <Icon name="carbon:list" class="icon-sm" />
        In Research
      </span>
      <Icon name="carbon:chevron-down" class="category-nav-inline-icon" />
    </summary>
    <nav class="category-nav-inline-content" aria-label="In Research articles">
      <ul class="category-nav-list">
        {
          allArticles.map((article) => {
            const isCurrent = article.id === item.id
            return (
              <li class="category-nav-item">
                <a
                  href={article.href}
                  class:list={[
                    "category-nav-link",
                    { "category-nav-link-active": isCurrent }
                  ]}
                  aria-current={isCurrent ? "page" : undefined}
                >
                  {article.title}
                </a>
              </li>
            )
          })
        }
      </ul>
    </nav>
  </details>

  <Frontmatter slot="content-top" {minutesRead} {lastUpdatedOn} {isDraft} class="my-4" />

  <!-- Main content (default slot) -->
  <article class="article-prose-content">
    <Content />
  </article>

  <!-- Content bottom (below main) -->
  <ArticleTags slot="content-bottom" {tags} />
</Layout>
