---
import { Icon } from "astro-icon/components"
import ArticleNavigation from "@/components/article-navigation.astro"
import ArticleTags from "@/components/article-tags.astro"
import CategoryNav from "@/components/category-nav.astro"
import TOC from "@/components/toc.astro"
import Frontmatter from "@/components/frontmatter.astro"
import Layout from "@/layout/layout.astro"
import ReadingProgress from "@/components/reading-progress.astro"
import { POST_TYPE_LABELS } from "@/utils/content-categories-generic.utils"
import { getPostsIncludingDrafts } from "@/utils/content-collection.utils"
import type { ContentItem, PostType } from "@/utils/content.type"

// Generate static paths for all posts (including drafts)
export async function getStaticPaths() {
  const posts = await getPostsIncludingDrafts()

  return posts.map((post, index) => {
    // Get posts of the same type for prev/next navigation
    const sameTypePosts = posts.filter((p) => p.postType === post.postType)
    const sameTypeIndex = sameTypePosts.findIndex((p) => p.id === post.id)
    const nextPost = sameTypeIndex < sameTypePosts.length - 1 ? sameTypePosts[sameTypeIndex + 1] : null
    const prevPost = sameTypeIndex > 0 ? sameTypePosts[sameTypeIndex - 1] : null

    // Get all articles in the current category for category nav
    const categoryArticles = post.category
      ? posts
          .filter((p) => p.category?.id === post.category?.id && p.postType === post.postType)
          .map((p) => ({
            id: p.id,
            title: p.title,
            href: p.href,
          }))
      : []

    return {
      params: {
        postType: post.postType,
        category: post.category?.id || "uncategorized",
        slug: post.pageSlug.split("/").pop() || post.pageSlug,
      },
      props: {
        post,
        categoryArticles,
        nextPost,
        prevPost,
      },
    }
  })
}

interface Props {
  post: ContentItem
  categoryArticles: { id: string; title: string; href: string }[]
  nextPost: ContentItem | null
  prevPost: ContentItem | null
}

const { post, categoryArticles, nextPost, prevPost } = Astro.props
const { description, publishedOn, lastUpdatedOn, title, minutesRead, tags, Content, isDraft, category, postType } = post

const parentLabel = POST_TYPE_LABELS[postType]
const crumbs = [
  { name: parentLabel, href: `/posts/${postType}` },
  ...(category ? [{ name: category.title, href: category.href, title: category.title }] : []),
]

// Show category nav when there are other articles in the same category
const showCategoryNav = categoryArticles.length > 0
---

<Layout {title} {description} {crumbs} pageType="article" noIndex={isDraft} layout="3col">
  <!-- Category Nav in left sidebar (desktop only) -->
  {showCategoryNav && category && (
    <CategoryNav
      slot="sidebar-left"
      categoryName={category.title}
      articles={categoryArticles}
      currentArticleId={post.id}
    />
  )}

  <!-- TOC in right sidebar -->
  <TOC slot="sidebar-right" />

  <!-- Content top (above main) -->
  <ReadingProgress slot="content-top" />

  <!-- Category Nav inline (mobile/tablet only) -->
  {showCategoryNav && category && (
    <details slot="content-top" class="category-nav-inline" id="category-nav-inline">
      <summary class="category-nav-inline-summary">
        <span class="category-nav-inline-title">
          <Icon name="carbon:list" class="icon-sm" />
          {category.title}
        </span>
        <Icon name="carbon:chevron-down" class="category-nav-inline-icon" />
      </summary>
      <nav class="category-nav-inline-content" aria-label={`${category.title} articles`}>
        <ul class="category-nav-list">
          {
            categoryArticles.map((article) => {
              const isCurrent = article.id === post.id
              return (
                <li class="category-nav-item">
                  <a
                    href={article.href}
                    class:list={[
                      "category-nav-link",
                      { "category-nav-link-active": isCurrent }
                    ]}
                    aria-current={isCurrent ? "page" : undefined}
                  >
                    {article.title}
                  </a>
                </li>
              )
            })
          }
        </ul>
      </nav>
    </details>
  )}

  <Frontmatter slot="content-top" {minutesRead} {publishedOn} {lastUpdatedOn} {isDraft} class="my-4" />

  <!-- Main content (default slot) -->
  <article class="article-prose-content">
    <Content />
  </article>

  <!-- Content bottom (below main) -->
  <ArticleTags slot="content-bottom" {tags} />
  <ArticleNavigation slot="content-bottom" prevItem={prevPost} nextItem={nextPost} />
</Layout>
