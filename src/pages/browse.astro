---
import AccordionScript from "@/components/accordion-script.astro"
import Link from "@/components/link.astro"
import TopicAccordion from "@/components/topic-accordion.astro"
import SidebarNavBrowse from "@/components/sidebar-nav-browse.astro"
import Layout from "@/layout/layout.astro"
import { getBrowseContent } from "@/utils/content"
import { formatCount } from "@/utils/format.utils"

// Get full hierarchy: categories -> topics -> articles (all ordered by ordering.json5)
const categoryData = await getBrowseContent()

// Calculate totals
const totalCategories = categoryData.length
const totalTopics = categoryData.reduce((sum, cat) => sum + cat.topicCount, 0)
const totalArticles = categoryData.reduce((sum, cat) => sum + cat.articleCount, 0)

const crumbs: { name: string; href: string }[] = []
---

<Layout
  title="Browse"
  description="Browse all content by category and topic"
  {crumbs}
  pageType="browse"
  hasLeftSidebar={true}
>
  <SidebarNavBrowse slot="sidebar-left" />

  <h1 class="page-title">Browse</h1>
  <p class="page-description">Explore all content organized by category and topic.</p>

  <p class="browse-stats">
    {formatCount(totalCategories, "Category", "Categories")} &middot; {formatCount(totalTopics, "Topic")} &middot; {
      formatCount(totalArticles, "Article")
    }
  </p>

  <div class="section-divider">
    <span class="section-divider-text">Categories</span>
  </div>

  <div class="browse-categories">
    {
      categoryData.map((category, catIndex) => (
        <section class="browse-category" style={`animation-delay: ${catIndex * 150}ms`}>
          <div class="browse-category-header">
            <h2 class="browse-category-title">
              <Link href={category.href}>{category.name}</Link>
            </h2>
            <p class="browse-category-meta">
              {formatCount(category.topicCount, "Topic")} Â· {formatCount(category.articleCount, "Article")}
            </p>
          </div>

          <div class="browse-topics">
            {category.topics.map((topic) => (
              <TopicAccordion topic={topic} showCategory={false} headingLevel="h3" />
            ))}
          </div>
        </section>
      ))
    }
  </div>

  <AccordionScript />
</Layout>

<style is:global>
  @reference "tailwindcss";

  .browse-stats {
    @apply mb-10 text-sm;
    color: var(--color-text-muted);
    animation: fadeInUp var(--transition-slow) 200ms forwards;
    opacity: 0;
  }

  .browse-categories {
    @apply flex flex-col gap-12;
  }

  .browse-category {
    @apply flex flex-col;
    animation: fadeInUp var(--transition-slow) forwards;
    opacity: 0;
  }

  .browse-category-header {
    @apply sticky py-4;
    top: var(--header-height);
    z-index: 20;
    background: linear-gradient(to bottom, var(--color-bg) 80%, transparent);
  }

  .browse-category-title {
    @apply mb-0 font-sans text-2xl font-normal md:text-3xl;
    color: var(--color-text);
  }

  .browse-category-title a {
    @apply no-underline;
    color: inherit;
    transition: color var(--transition-fast);
  }

  .browse-category-title a:hover {
    color: var(--color-text-muted);
  }

  .browse-category-header .browse-category-meta {
    @apply mt-2 mb-0 text-sm;
    color: var(--color-text-muted);
  }

  .browse-topics {
    @apply flex flex-col;
  }
</style>
