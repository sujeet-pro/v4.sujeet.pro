---
import Link from "@/components/link.astro"
import Layout from "@/layout/layout.astro"
import { getAllContentByType } from "@/utils/content-filters.utils"
import { getCategoriesForType, POST_TYPE_LABELS } from "@/utils/content-categories-generic.utils"
import { getAllTagsWithCounts } from "@/utils/content-tags.utils"
import type { PostType } from "@/utils/content.type"

const contentByType = await getAllContentByType()
const postTypes: PostType[] = ["deep-dives", "notes"]

// Get categories for each type
const categoriesByType = new Map()
for (const type of postTypes) {
  const items = contentByType.get(type) || []
  const categories = await getCategoriesForType(type, items)
  categoriesByType.set(type, categories)
}

// Get all tags with counts (already sorted by count descending)
const sortedTags = await getAllTagsWithCounts()

const crumbs: { title: string; href: string }[] = []
---

<Layout title="Browse" description="Browse content by category, type, or tag" {crumbs} pageType="default">
  <h1 class="page-title">Browse</h1>
  <p class="page-description">Explore content by category, type, or tag.</p>

  {/* Content by Type */}
  <section class="mb-12">
    <h2 class="mb-6 text-xl font-light">By Post Type</h2>
    <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-4">
      {
        postTypes.map((type) => {
          const items = contentByType.get(type) || []
          const categories = categoriesByType.get(type) || []
          return (
            <div class="browse-card">
              <h3 class="mb-2 text-lg font-medium">
                <Link href={`/posts/${type}`} class="hover:underline">
                  {POST_TYPE_LABELS[type]}
                </Link>
              </h3>
              <p class="text-muted text-sm mb-3">{items.length} items</p>
              <ul class="text-sm space-y-1">
                {categories.slice(0, 3).map((cat) => (
                  <li>
                    <Link href={cat.href} class="text-muted hover:underline" title={cat.title}>
                      {cat.name} ({cat.items.length})
                    </Link>
                  </li>
                ))}
                {categories.length > 3 && (
                  <li class="text-muted">+{categories.length - 3} more</li>
                )}
              </ul>
            </div>
          )
        })
      }
    </div>
  </section>

  {/* Categories by Type */}
  {
    postTypes.map((type) => {
      const categories = categoriesByType.get(type) || []
      if (categories.length === 0) return null
      return (
        <section class="mb-12">
          <h2 class="mb-4 text-xl font-light">
            <Link href={`/posts/${type}`} class="hover:underline">
              {POST_TYPE_LABELS[type]}
            </Link>
            {" Categories"}
          </h2>
          <div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
            {categories.map((cat) => (
              <div class="browse-card">
                <h3 class="mb-2 font-medium">
                  <Link href={cat.href} class="hover:underline">
                    {cat.name}
                  </Link>
                  <span class="text-muted ml-2 text-sm">({cat.items.length})</span>
                </h3>
                <p class="text-muted text-sm">{cat.description}</p>
              </div>
            ))}
          </div>
        </section>
      )
    })
  }

  {/* Tag Cloud */}
  <section class="mb-12">
    <h2 class="mb-4 text-xl font-light">
      <Link href="/tag" class="hover:underline">Tags</Link>
    </h2>
    <div class="flex flex-wrap gap-2">
      {
        sortedTags.slice(0, 50).map((tag) => (
          <Link href={tag.href} class="tag">
            {tag.name} ({tag.count})
          </Link>
        ))
      }
      {sortedTags.length > 50 && (
        <Link href="/tag" class="tag">
          +{sortedTags.length - 50} more
        </Link>
      )}
    </div>
  </section>
</Layout>

<style is:global>
  @reference "tailwindcss";

  .browse-card {
    @apply rounded-lg border p-4;
    border-color: var(--color-border);
    transition: border-color var(--transition-fast);
  }

  .browse-card:hover {
    border-color: var(--color-accent);
  }
</style>
