---
import AccordionScript from "@/components/accordion-script.astro"
import Link from "@/components/link.astro"
import TopicAccordion from "@/components/topic-accordion.astro"
import Layout from "@/layout/layout.astro"
import { getBrowseContent } from "@/utils/content"
import { formatCount } from "@/utils/format.utils"

// Get full hierarchy: categories -> topics -> articles (all ordered by ordering.json5)
const categoryData = await getBrowseContent()

// Calculate totals
const totalCategories = categoryData.length
const totalTopics = categoryData.reduce((sum, cat) => sum + cat.topicCount, 0)
const totalArticles = categoryData.reduce((sum, cat) => sum + cat.articleCount, 0)

const crumbs: { name: string; href: string }[] = []
---

<Layout title="Browse" description="Browse all content by category and topic" {crumbs} pageType="default">
  <h1 class="page-title">Browse</h1>
  <p class="page-description">Explore all content organized by category and topic.</p>

  <p class="browse-stats">
    {formatCount(totalCategories, "Category", "Categories")} · {formatCount(totalTopics, "Topic")} · {
      formatCount(totalArticles, "Article")
    }
  </p>

  <div class="browse-categories">
    {
      categoryData.map((category) => (
        <section class="browse-category">
          <div class="browse-category-header">
            <h2 class="browse-category-title">
              <Link href={category.href}>{category.name}</Link>
            </h2>
            <p class="browse-category-meta">
              {formatCount(category.topicCount, "Topic")} · {formatCount(category.articleCount, "Article")}
            </p>
          </div>

          <div class="browse-topics">
            {category.topics.map((topic) => (
              <TopicAccordion topic={topic} showCategory={false} headingLevel="h3" />
            ))}
          </div>
        </section>
      ))
    }
  </div>

  <AccordionScript />
</Layout>

<style is:global>
  @reference "tailwindcss";

  /* Browse page stats */
  .browse-stats {
    @apply mb-8 text-xs;
    color: var(--color-text-muted);
  }

  /* Category sections */
  .browse-categories {
    @apply flex flex-col gap-8;
  }

  .browse-category {
    @apply flex flex-col;
  }

  /* Sticky category header - positioned below site header */
  .browse-category-header {
    @apply sticky py-3;
    /* Site header is ~3rem tall (py-2 + content) */
    top: 3rem;
    z-index: 20;
    background: var(--color-bg);
  }

  .browse-category-title {
    @apply mb-0 font-sans text-xl font-semibold md:text-2xl;
    color: var(--color-text);
  }

  .browse-category-title a {
    @apply no-underline;
    color: inherit;
    transition: color var(--transition-fast);
  }

  .browse-category-title a:hover {
    color: var(--color-accent);
  }

  .browse-category-header .browse-category-meta {
    @apply mt-1 mb-0 text-xs;
    color: var(--color-text-muted);
  }

  /* Topic sections - no indent needed, typography provides hierarchy */
  .browse-topics {
    @apply flex flex-col;
  }
</style>
