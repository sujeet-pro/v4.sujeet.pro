---
import Link from "@/components/link.astro"
import Layout from "@/layout/layout.astro"
import { getBrowseContent } from "@/utils/content"
import { formatCount } from "@/utils/format.utils"

// Get full hierarchy: categories -> topics -> articles (all ordered by ordering.jsonc)
const categoryData = await getBrowseContent()

// Calculate totals
const totalCategories = categoryData.length
const totalTopics = categoryData.reduce((sum, cat) => sum + cat.topicCount, 0)
const totalArticles = categoryData.reduce((sum, cat) => sum + cat.articleCount, 0)

const crumbs: { name: string; href: string }[] = []
---

<Layout title="Browse" description="Browse all content by category and topic" {crumbs} pageType="default">
  <h1 class="page-title">Browse</h1>
  <p class="page-description">Explore all content organized by category and topic.</p>

  <p class="browse-stats">
    {formatCount(totalCategories, "Category", "Categories")} · {formatCount(totalTopics, "Topic")} · {
      formatCount(totalArticles, "Article")
    }
  </p>

  <div class="browse-categories">
    {
      categoryData.map((category, index) => (
        <section class="browse-category">
          {index > 0 && <hr class="browse-category-divider" />}
          <div class="browse-category-header">
            <h2 class="browse-category-title">
              <Link href={category.href}>{category.name}</Link>
            </h2>
            <p class="browse-category-meta">
              {formatCount(category.topicCount, "Topic")} · {formatCount(category.articleCount, "Article")}
            </p>
          </div>

          <div class="browse-topics">
            {category.topics.map((topic) => (
              <div class="browse-topic">
                <div class="browse-topic-header">
                  <h3 class="browse-topic-title">
                    <Link href={topic.href}>{topic.name}</Link>
                  </h3>
                  <p class="browse-topic-meta">{formatCount(topic.articleCount, "Article")}</p>
                </div>

                <div class="browse-articles">
                  {topic.articles.map((article) => (
                    <a href={article.href} class="browse-article">
                      <h4 class="browse-article-title">{article.title}</h4>
                      <p class="browse-article-excerpt">{article.description}</p>
                    </a>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </section>
      ))
    }
  </div>
</Layout>

<style is:global>
  @reference "tailwindcss";

  /* Browse page stats */
  .browse-stats {
    @apply mb-8 text-xs;
    color: var(--color-text-muted);
  }

  /* Category sections */
  .browse-categories {
    @apply flex flex-col;
  }

  .browse-category {
    @apply flex flex-col;
  }

  /* Category divider */
  .browse-category-divider {
    @apply my-8 border-t;
    border-color: var(--color-border);
  }

  /* Sticky category header - positioned below site header */
  .browse-category-header {
    @apply sticky py-3;
    /* Site header is ~3rem tall (py-2 + content) */
    top: 3rem;
    z-index: 20;
    background: var(--color-bg);
  }

  .browse-category-title {
    @apply mb-0 font-sans text-xl font-semibold md:text-2xl;
    color: var(--color-text);
  }

  .browse-category-title a {
    @apply no-underline;
    color: inherit;
    transition: color var(--transition-fast);
  }

  .browse-category-title a:hover {
    color: var(--color-accent);
  }

  .browse-category-header .browse-category-meta {
    @apply mt-1 mb-0 text-xs;
    color: var(--color-text-muted);
  }

  /* Topic sections */
  .browse-topics {
    @apply flex flex-col gap-4;
    padding-left: 1rem;
  }

  @media (min-width: 640px) {
    .browse-topics {
      padding-left: 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .browse-topics {
      padding-left: 2rem;
    }
  }

  .browse-topic {
    @apply flex flex-col;
  }

  /* Sticky topic header - sticks below site header + category header */
  .browse-topic-header {
    @apply sticky py-2;
    /* Site header (~3rem) + category header (~4rem) */
    top: 7rem;
    z-index: 10;
    background: var(--color-bg);
  }

  .browse-topic-title {
    @apply mb-0 font-sans text-lg font-medium;
    color: var(--color-text);
  }

  .browse-topic-title a {
    @apply no-underline;
    color: inherit;
    transition: color var(--transition-fast);
  }

  .browse-topic-title a:hover {
    color: var(--color-accent);
  }

  .browse-topic-header .browse-topic-meta {
    @apply mt-0.5 mb-0 text-xs;
    color: var(--color-text-muted);
  }

  /* Article list */
  .browse-articles {
    @apply flex flex-col gap-2;
    padding-left: 1rem;
  }

  @media (min-width: 640px) {
    .browse-articles {
      padding-left: 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .browse-articles {
      padding-left: 2rem;
    }
  }

  .browse-article {
    @apply block py-2 no-underline;
  }

  .browse-article:hover .browse-article-title {
    color: var(--color-accent);
  }

  .browse-article-title {
    @apply mb-1 font-sans text-base font-medium;
    color: var(--color-text);
    transition: color var(--transition-fast);
  }

  .browse-article-excerpt {
    @apply line-clamp-2 text-base;
    color: var(--color-text-muted);
  }
</style>
